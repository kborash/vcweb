{% extends "base.html" %}

{% block title %}Virtual Commons Web Experimenter Dashboard{% endblock %}

{% block content %}
    <div class='info'>
    Welcome back, {{ request.user.first_name}}.
</div>
<h3>Manage your sessions</h3>

<table width='100%'>
    <thead>
        <tr>
            <th width='25%'>Experiment</th>
            <th width='25%'>Start Date</th>
            <th width='25%'>End Date</th>
            <th class='quantity' width='10%'>Capacity</th>
            <th width='10%'> </th>
        </tr>
    </thead>
    <tbody data-bind='foreach: sessions'>
        <tr>
            <td>
                <select data-bind="options: $root.availableExperiment, value: experiment, optionsText:'title' "> </select>
            </td>
            <td>
                <input type="text" class="date-start" data-bind="datepicker : startDate" />
            </td>
            <td >
                <input type="text" class="date-end" data-bind="datepicker : endDate" />
            </td>
            <td class='quantity'>
                <input type="text" data-bind ="value : capacity" />
            </td>
            <td>
                <button data-bind="click: $root.saveSession">Save</button>
            </td>
            <td>
                <a href='#' data-bind="click: $root.removeSession">Remove</a>
            </td>
        </tr>
    </tbody>
</table>

<button data-bind='click: addSession'>Add Session</button>

{% endblock content %}

{% block javascript %}
{{ block.super }}
<script src='{{STATIC_URL}}js/bootstrap-datepicker.min.js'></script>
<link rel="stylesheet" href='{{ STATIC_URL }}css/datepicker.css'>

    <script type= "text/javascript">
    var sessionList = $.parseJSON("{{ view_model_json |escapejs }}");

    console.log(sessionList.experiments);

    $(function(){
        function Session(sessionData) {
            this.pk = sessionData.pk;
            this.experiment = ko.observable(sessionData.experiment);
            this.startDate = ko.observable(sessionData.startDate);
            this.endDate = ko.observable(sessionData.endDate);
            this.capacity = ko.observable(sessionData.capacity);
        }

        function sessionListViewModel(sessionList) {
            var self = this;
            self.sessions = ko.observableArray(sessionList.sessions);

            self.newSession = ko.observable();

            self.availableExperiment = sessionList.experiments;

            self.addSession = function() {
                self.sessions.push(new Session({ pk: -1, experiment: sessionList.experiments[2], startDate: new Date() , endDate: new Date(), capacity:0}));
            };

            self.removeSession = function(session) {
                self.sessions.remove(session);
            }

            self.saveSession = function(session) {
              console.log(ko.toJSON(session));
                $.ajax("/subject-pool/session/update", {
                    data:{ session: session },
                    type: "post",
                    success: function(result) { alert(result) }
                });
            };
        }

        ko.bindingHandlers.datepicker = {
            init: function(element, valueAccessor, allBindingsAccessor) {
              //initialize datepicker with some optional options
              var options = allBindingsAccessor().datepickerOptions || {};
              $(element).datepicker(options);

              //when a user changes the date, update the view model
              ko.utils.registerEventHandler(element, "changeDate", function(event) {
                     var value = valueAccessor();
                     if (ko.isObservable(value)) {
                         value(event.date);
                     }
              });
            },
            update: function(element, valueAccessor)   {
                var widget = $(element).data("datepicker");

                 //when the view model is updated, update the widget
                if (widget) {
                    widget.date = ko.utils.unwrapObservable(valueAccessor());
                    widget.setValue();
                }
            }
        };

        ko.applyBindings(new sessionListViewModel(sessionList));
    });
</script>
{% endblock %}