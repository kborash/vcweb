{% extends "experimenter/base.html" %}
{% block title %}
    Experiment Session Detail
{% endblock %}
{% block page %}
    <div id='page'>
        <a class="btn btn-default" href="{% url 'subjectpool:experimenter_index' %}"><i class="fa fa-arrow-left"></i> Back</a>
        <div id="session-detail" class="callout callout-info">
            <p><strong>Experiment: </strong>
            {{ session_detail.experiment_metadata.title }}
            <p><strong>Date/Time: </strong> {{ session_detail.scheduled_date.date }}, {{ session_detail.scheduled_date.time }} -
            {% if session_detail.scheduled_end_date.date != session_detail.scheduled_date.date %}
            {{ session_detail.scheduled_end_date.date }},
            {% endif %}
            {{ session_detail.scheduled_end_date.time }}</p>
            <p><strong>Location: </strong> {{ session_detail.location }}</p>
            <p><strong>Capacity: </strong> {{ session_detail.capacity }}</p>
            <p><strong>Waitlist enabled: </strong> {{ session_detail.waitlist }}</p>
        </div>
        <div class="alert alert-warning">
            {% if formset.forms|length > 0 %}
                <a target="_blank" href="/subject-pool/session/{{ session_detail.pk }}/download/">Download Registered Participants</a>
            {% endif %}
            <form class="form-inline">
                <div class="form-group">
                    <label for="bulkAction">Mark All Participants as: </label>
                    <select id="bulkAction" name="bulkAction" class="form-control input-sm">
                        <option value="-1">select Action</option>
                        <option value="0">participated</option>
                        <option value="1">turned away</option>
                        <option value="2">absent</option>
                        <option value="3">signed up</option>
                        <option value="4">waitlisted</option>
                    </select>
                    Note: This will not save the changes, you still need to click on the save button to save the changes.
                </div>
            </form>
        </div>
        <div class="alert alert-warning">
            <span id="add-participant-error" class="alert-danger"></span>
            <form class="form-inline" id="addParticipant">
                {% csrf_token %}
                <div class="form-group">
                    <label for="participantEmail">Add Participant with Email: </label>
                    <input type="text" id="participantEmail" name="participantEmail" class="form-control input-sm" />
                    <button type="submit" class="btn btn-default input-sm">Add Participant</button>
                </div>
            </form>
        </div>
        {% for dict in formset.errors %}
            {% for error in dict.values %}
                <div class="alert alert-error">
                    <strong>{{ error|escape }}</strong>
                </div>
            {% endfor %}
        {% endfor %}
        <h3>Registered Participants</h3>
        <form method="POST" id="participant-info" class="form-inline">
            {% csrf_token %}
            {{ formset.management_form }}
            <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" id="participant-table">
                <thead>
                    <tr>
                        <th> First Name </th>
                        <th> Last Name </th>
                        <th> Email </th>
                        <th> Major </th>
                        <th> Class Status </th>
                        <th> Attendance </th>
                    </tr>
                </thead>
                {% for form in formset.forms %}
                {% with form.instance.invitation.participant as participant %}
                <tr>
                    <td>
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                        {{ participant.first_name }}</td>
                    <td>{{ participant.last_name }}</td>
                    <td>{{ participant.email }}</td>
                    <td>{{ participant.major }}</td>
                    <td>{{ participant.class_status }}</td>
                    {% for field in form.visible_fields %}
                        <td>{{ field }}</td>
                    {% endfor %}
                </tr>
                    {% endwith %}
            {% endfor %}
            </table>
            {% if formset.forms|length > 0 %}
                <button type="submit" class="btn btn-success" id="submit-attendance">
                    <i class="fa fa-floppy-o"></i>
                    save
                </button>
            {% endif %}
        </form>
    </div>
{% endblock %}
{% block javascript %}
    {{ block.super }}
    <script type="text/javascript" src="//cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js"></script>

    <script type="text/javascript">
        $(function(){

            $("#bulkAction").change(function() {
                var optionVal = $(this).val();
                if(optionVal != -1) {
                    $("#participant-table").find("select").val(optionVal);
                }
            });

            $("#addParticipant").submit(function(event) {
                $.post("{% url 'subjectpool:add_participant' session_detail.pk %}", $(event.target).serialize(), function(data) {
                    console.log(data.success);
                    if(data.success) {
                        // reload page to show the added participant
                        location.reload();
                    } else {
                        $("#add-participant-error").text("ERROR: " + data.error);
                    }
                }).fail(function(data) {
                    if(data.status == 404) {
                        $("#add-participant-error").text("ERROR: Participant not found in the system. Please contact the administrator");
                    } else {
                        $("#add-participant-error").text("ERROR: Something went wrong. Please try again, If issue persists please contact the administrator");
                    }
                });
                event.preventDefault();
            });

            oTable = $('#participant-table').dataTable( {
                "sDom": "<'pull-right'f><'clearfix'r>t<'col-md-6'i>",
                "sWrapper": "dataTables_wrapper",
                "paging": false,
            });

            // SEARCH - Add the placeholder for Search and Turn it into in-line formcontrol
            var search_input = $('#participant-table').closest('.dataTables_wrapper').find('div[id$=_filter] input');
            search_input.attr('placeholder', 'Search');
            search_input.addClass('form-control input-sm');
            search_input.css('width', '150px');


            $("#submit-attendance").click(function() {
                oTable.fnFilter('');
            });
        });
    </script>
{% endblock %}
