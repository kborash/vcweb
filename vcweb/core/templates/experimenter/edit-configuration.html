{% extends "experimenter/base.html" %}
{% load bootstrap3 %}
{% load tags %}

{% block title %}Virtual Commons Web Experimenter Dashboard{% endblock %}
{% block head %}
{{ block.super }}
{% endblock %}

{% block page %}

    <h2> Experiment Configuration</h2>
    <form method="post" class="form-horizontal">
            {{ experiment_config_form.non_field_errors }}
            <div class="col-md-6">
                <div id="experiment_config_pk" style="display: none;">
                    {{experiment_config.pk}}
                </div>
                <div class="form-group">
                    <label class="col-md-4 control-label">Experiment metadata</label>
                    <div class="col-md-8">
                        {{ experiment_config_form.experiment_metadata|addcss:"form-control input-sm" }}
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-4 control-label">Name</label>
                    <div class="col-md-8">
                        {{ experiment_config_form.name|addcss:"form-control input-sm" }}
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-4 control-label">Treatment id</label>
                    <div class="col-md-8">
                        {{ experiment_config_form.treatment_id|addcss:"form-control input-sm" }}
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-4 control-label">Registration email subject</label>
                    <div class="col-md-8">
                        {{ experiment_config_form.registration_email_subject|addcss:"form-control input-sm" }}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-5 control-label">Max number of participants</label>
                    <div class="col-md-2">
                        {{ experiment_config_form.max_number_of_participants|addcss:"form-control input-sm" }}
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-5 control-label">Max group size</label>
                    <div class="col-md-2">
                        {{ experiment_config_form.max_group_size|addcss:"form-control input-sm" }}
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-5 control-label">Exchange rate</label>
                    <div class="col-md-2">
                        {{ experiment_config_form.exchange_rate|addcss:"form-control input-sm" }}
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-5 control-label">Is Public</label>
                    <div class="col-md-7">
                        <div class="checkbox">
                            <label>{{ experiment_config_form.is_public }}</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-5 control-label">Is experimenter driven</label>
                    <div class="col-md-7">
                        <div class="checkbox">
                            <label>{{ experiment_config_form.is_experimenter_driven }}</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-5 control-label">Has daily rounds</label>
                    <div class="col-md-7">
                        <div class="checkbox">
                            <label>{{ experiment_config_form.has_daily_rounds }}</label>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    <div class="panel-group" id="accordion">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#collapseTwo">
                        Experiment Parameter Value
                    </a>
                </h4>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse">
                <div class="panel-body">
                    <div data-bind='if: experiment_param_val().length == 0'>
                        <div class="callout callout-warning">
                            No experiment parameters found. Click the "Add Experiment Parameter" button below to add a new one.
                        </div>
                    </div>
                    <ul data-bind="foreach: experiment_param_val">
                        <li>
                            <span data-bind="text: display_name"></span>
                        </li>
                    </ul>
                    <button type="button" class="btn" data-bind="click: $root.showExpParamModel"><i class='fa fa-plus'></i> Add Experiment Parameter</button>
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#collapseThree">
                        Round Configuration
                    </a>
                </h4>
            </div>
            <div id="collapseThree" class="panel-collapse collapse">
                <div class="panel-body">
                    <div data-bind='if: round_config().length == 0'>
                        <div class="callout callout-warning">
                            No Rounds found for this Experiment Configuration. Click the "Add Round Configuration" button below to add a new one.
                        </div>
                    </div>
                    <div id="tree">
                        <ul data-bind="foreach: round_config">
                            <li>
                                <span class="tree-item fa" data-bind="
                                    css: {
                                        'fa-minus-square-o': isExpanded() && children().length > 0,
                                        'fa-plus-square-o': !isExpanded() && children().length > 0,
                                        'fa-square-o': children().length === 0,
                                        'pointer-icon': children().length > 0
                                    }, click: toggleVisibility
                                    "></span>
                                <span data-bind="text: display_name()"></span>
                                <a href='#' data-bind='click: $root.addRoundParam'><i class="fa fa-plus"></i></a>
                                <a href='#' data-bind='click: $root.editRoundConfig'><i class="fa fa-edit"></i></a>
                                <a href='#' data-bind='click: $root.removeRoundConfig'><i class="fa fa-power-off"></i></a>
                                <div data-bind="slideVisible: isExpanded">
                                    <ul data-bind="foreach: children">
                                        <li>
                                            <span class="tree-item fa fa-stop"></span>
                                            <span data-bind="text: display_name"></span>
                                            <a href='#' data-bind='click: $root.editRoundParam'><i class="fa fa-edit"></i></a>
                                            <a href='#' data-bind='click: $root.removeRoundParam'><i class="fa fa-power-off"></i></a>
                                        </li>
                                    </ul>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <button type="button" class="btn" data-bind="click: $root.showRoundConfigModal"><i class='fa fa-plus'></i> Add Round Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" data-bind="showModal: activateModal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true" data-bind="click:hideModal">&times;</button>
                    <h4 class="modal-title">Edit Details and Click Save</h4>
                </div>
                <div class="modal-body" data-bind="with: modalData" >
                    <div data-bind='template: { name: $root.template }'></div>
                </div>
            </div>
        </div>
    </div>
{% endblock page %}
{% block javascript %}
{{ block.super }}

    <script src="{{ STATIC_URL }}js/jquery-ui.min.js"></script>

    <script type='text/html' id='round-param-template'>
        <form method="post" class="form-horizontal" data-bind="submit: $root.saveRoundParam">
            <input type="hidden" data-bind="value: pk">
            <!-- ko if: parent_pk -->
            <input type="hidden" data-bind="value: parent_pk" class="parent_pk">
            <!-- /ko -->
            <!-- ko template: { name: 'param-template' }-->
            <!-- /ko -->
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </script>

    <script type='text/html' id='exp-param-template'>
        <form method="post" class="form-horizontal" data-bind="submit: $root.saveExpParam">
            <!-- ko template: { name: 'param-template' }-->
            <!-- /ko -->
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </script>

    <script type="text/html" id="param-template">
        <div class="form-group">
            <label class="col-md-3 control-label">Parameter</label>
            <div class="col-md-6">
                <select class="form-control" id="id_parameter" name="parameter" placeholder="Parameter" data-bind="
                    options: parameter_list,
                    optionsText: function(item) {
                        var firstLetterCapital = item.name().charAt(0).toUpperCase() + item.name().slice(1);
                        return firstLetterCapital.replace(/_(.)/g, function(match, group1) {
                            return ' '+group1.toUpperCase();
                        });
                    },
                    optionsValue: 'pk',
                    value: selectedParameterPk
                    ">
                </select>
            </div>
        </div>
        <div class="form-group" data-bind="visible: isVisible('string,enum,foreignkey') ">
            <label class="col-md-3 control-label">String value</label>
            <div class="col-md-6">
                <textarea class="form-control" id="id_string_value" name="string_value" placeholder="String value" rows="3" data-bind="value: stringValue"></textarea>
            </div>
        </div>
        <div class="form-group" data-bind="visible: isVisible('int')">
            <label class="col-md-3 control-label">Int value</label>
            <div class="col-md-6">
                <input class="form-control" id="id_int_value" name="int_value" placeholder="Int value" type="number" data-bind="value: intValue">
            </div>
        </div>
        <div class="form-group" data-bind="visible: isVisible('float')">
            <label class="col-md-3 control-label">Float value</label>
            <div class="col-md-6">
                <input class="form-control" id="id_float_value" name="float_value" placeholder="Float value" step="any" type="number" data-bind="value: floatValue">
            </div>
        </div>
        <div class="form-group" data-bind="visible: isVisible('boolean')">
            <label class="col-md-3 control-label">Boolean value</label>
            <div class="col-md-6">
                <select class="form-control" id="id_boolean_value" name="boolean_value" data-bind="value: booleanValue">
                    <option value="2">Choose...</option>
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">&nbsp;</label>
            <div class="col-md-6">
                <div class="checkbox">
                    <label><input checked="checked" id="id_is_active" name="is_active" type="checkbox" data-bind="checked: isActive"> Is active</label>
                </div>
            </div>
        </div>
    </script>

    <script type="text/html" id="round-config-template">
        <form class="form-horizontal" data-bind="submit: $root.saveRoundConfig">
        <input type="hidden" data-bind="value: pk">
        <div class="form-group">
            <label class="col-md-4 control-label" for="round_type">Round Type</label>
            <div class="col-md-6">
                <select id="id_round_type" name="round_type" class="form-control input-sm" data-bind="value: round_type">
                    <option value="CHAT">Chat round</option>
                    <option value="DEBRIEFING">Debriefing round</option>
                    <option value="GENERAL_INSTRUCTIONS">General introduction to the experiment</option>
                    <option value="INSTRUCTIONS">Instructions round</option>
                    <option value="PRACTICE">Practice round</option>
                    <option value="QUIZ">Quiz round</option>
                    <option value="REGULAR">Regular experiment round</option>
                    <option value="WELCOME" selected="selected">Initial welcome page</option>
                </select>
            </div>
        </div>
   	    <div class="form-group">
            <label class="col-md-4 control-label" for="round_type">Sequence Number</label>
            <div class="col-md-6">
                <input type="text" id="sequence_number" name="sequence_number" class="form-control input-sm" data-bind="value: sequence_number">
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-4 control-label" for="display_number">Display Number</label>
            <div class="col-md-6">
                <input id="display_number" name="display_number" type="text" class="form-control input-sm" data-bind="value: display_number">
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-4 control-label" for="duration">Duration</label>
            <div class="col-md-6">
                <input id="duration" name="duration" type="text" class="form-control input-sm" data-bind="value: duration">
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-4 control-label" for="template_id">Template ID</label>
            <div class="col-md-6">
                <input id="template_id" name="template_id" type="text" class="form-control input-sm" data-bind="value: template_id">
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-4 control-label" for="survey_url">Survey Url</label>
            <div class="col-md-6">
                <input id="survey_url" name="survey_url" type="text" placeholder="" class="form-control input-sm" data-bind="value: survey_url">
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-4 control-label" for="session_id">Session ID</label>
            <div class="col-md-6">
                <input id="session_id" name="session_id" type="text" placeholder="" class="form-control input-sm" data-bind="value: session_id">
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-4 control-label" for="repeat">Repeat</label>
            <div class="col-md-6">
                <input id="repeat" name="repeat" type="text" class="form-control input-sm" data-bind="value: repeat">
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-4 col-sm-8">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="randomize_groups" data-bind="checked: randomize_groups"> Randomize Groups
                    </label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-4 col-sm-8">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="preserve_existing_groups" data-bind="checked: preserve_existing_groups">
                        Preserve Existing Groups
                    </label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-4 col-sm-8">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="create_group_clusters" data-bind="checked: create_group_clusters">
                        Create Group Clusters
                    </label>
              </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-4 col-sm-8">
                <div class="checkbox">
                    <label>
                      <input type="checkbox" name="initialize_data_values" data-bind="checked: initialize_data_values">
                      Initialize Data Values
                    </label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-4 col-sm-8">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="chat_enabled" data-bind="checked: chat_enabled">
                        Chat Enabled
                    </label>
                 </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save</button>
        </div>
    </form>
    </script>

    <script type="text/javascript">
        var JSONdata = $.parseJSON("{{ json_data | escapejs }}");
        window.x = JSONdata;

        $(function() {

            //wrapper to an observable that requires accept/cancel
            ko.protectedObservable = function(initialValue) {
                //private variables
                var _actualValue = ko.observable(initialValue),
                    _tempValue = initialValue;

                //computed observable that we will return
                var result = ko.computed({
                    //always return the actual value
                    read: function() {
                       return _actualValue();
                    },
                    //stored in a temporary spot until commit
                    write: function(newValue) {
                         _tempValue = newValue;
                    }
                });

                //if different, commit temp value
                result.commit = function() {
                    if (_tempValue !== _actualValue()) {
                         _actualValue(_tempValue);
                    }
                };

                //return updatedValue
                result.updateValue = function() {
                    return _tempValue;
                }

                //force subscribers to take original
                result.reset = function() {
                    _actualValue.valueHasMutated();
                    _tempValue = _actualValue();   //reset temp value
                };

                return result;
            };

            function NodeModel(data) {

                var self = this;

                self.isExpanded = ko.observable(false);

                self.name = ko.protectedObservable(data.name);
                self.display_name = function() {
                   return self.repeat() > 0 ? self.name() + ' ' + self.sequence_number() + ' [x '+ self.repeat() +']': self.name() + ' ' + self.sequence_number();
                }
                self.children = ko.observableArray(data.children);

                self.pk = ko.protectedObservable(data.pk);
		        self.round_type = ko.protectedObservable(data.round_type);
                self.sequence_number = ko.protectedObservable(data.sequence_number)
                self.display_number = ko.protectedObservable(data.display_number);
                self.duration = ko.protectedObservable(data.duration);
                self.template_id = ko.protectedObservable(data.template_id);
                self.survey_url = ko.protectedObservable(data.survey_url);
                self.randomize_groups = ko.protectedObservable(data.randomize_groups);
                self.preserve_existing_groups = ko.protectedObservable(data.preserve_existing_groups);
                self.create_group_clusters = ko.protectedObservable(data.create_group_clusters);
                self.session_id = ko.protectedObservable(data.session_id);
                self.repeat = ko.protectedObservable(data.repeat);
                self.initialize_data_values = ko.protectedObservable(data.initialize_data_values);
                self.chat_enabled = ko.protectedObservable(data.chat_enabled);
                self.old_sequence_number = -1;

                self.sequence_number.subscribe( function (old_value) {
                    self.old_sequence_number = old_value;
                }, self, 'beforeChange');

                self.toggleVisibility = function() {
                    self.isExpanded(!self.isExpanded());
                };

                self.update = function(nodeObject) {
                    var fields = [
                        "name", "round_type", "display_number", "sequence_number", "duration", "template_id",
                        "survey_url", "randomize_groups", "preserve_existing_groups", "create_group_clusters",
                        "session_id", "repeat", "initialize_data_values", "chat_enabled"
                    ];
                    $.each(fields, function() {
                        var property = self[this];
                        property(nodeObject[this]);
                        property.commit();
                    });
                }
            };

            function ExperimentParamModel(data) {
                var self = this;

                self.display_name = ko.observable(data.display_name);
            }

            function PageModel(data) {

                var mapping = {
                    'round_config': {
                        create: function (options) {
                            return new NodeModel(options.data);
                        }
                    },
                    'experiment_param_val': {
                        create: function (options) {
                            return new ExperimentParamModel(options.data);
                        }
                    }
                };
                var model = ko.mapping.fromJS(data, mapping);

                model.template = ko.observable();
                model.activateModal = ko.observable(false);
                model.modalData = ko.observable();
                model.old_sequence_number = "";

                model.sorted_round_config = function() {
                    return model.round_config().sort(function(left, right) { return left.sequence_number() < right.sequence_number() ? -1 : 1 });
                };

                model.showExpParamModel = function (data, event) {
                    var temp = new ParamViewModel({}, model.exp_parameter_list());
                    model.modalData(temp);
                    model.template("exp-param-template");
                    model.activateModal(true);
                }

                model.addRoundParam = function(roundConfig) {
                    var temp = new ParamViewModel({'parent_pk': roundConfig.pk()}, model.round_parameter_list());
                    model.modalData(temp);
                    model.template("round-param-template");
                    model.activateModal(true);
                }

                model.removeRoundParam = function(round_param) {
                    $.each(model.round_config(), function() { this.children.remove(round_param) })
                };

                model.removeRoundConfig = function(round_config) {

                    $.ajax("/api/configuration/round/"+ round_config.pk(), {
                        data: 'request_type=delete',
                        type: "POST",
                        success: function(result) {
                            if(result.success){
                                model.round_config.remove(round_config);
                            }
                        }
                    });
                }

                model.editRoundParam = function(round_param) {
                    model.modalData(new ParamViewModel(round_param, model.round_parameter_list()));
                    model.template("round-param-template");
                    model.activateModal(true);
                }

                model.editRoundConfig = function(data) {
                    model.modalData(data);
                    model.template("round-config-template");
                    model.activateModal(true);
                }

                model.showRoundConfigModal = function (data, event) {
                    model.modalData(new NodeModel({}));
                    model.template("round-config-template");
                    model.activateModal(true);
                }

                model.hideModal = function() {
                    model.activateModal(false);
                    model.template("");
                    model.modalData("");
                }

                model.saveRoundParam = function(form) {
                    var form = $(form);
                    var update = parseInt(form.find("input[type='hidden']").val());
                    var roundPk = form.find("input[type='hidden'].parent_pk").val();
                    var jsonObject  = form.serializeObject();

                    if (update) {
                        var match = ko.utils.arrayFirst(model.round_config(), function (item) {
                            return ko.utils.arrayFirst(item.children(), function(i){
                                if(update == i.pk) {
                                    i.string_value = jsonObject.string_value;
                                    i.int_value = jsonObject.int_value;
                                    i.float_value = jsonObject.float_value;
                                    i.boolean_value = jsonObject.boolean_value;
                                    i.is_active = jsonObject.is_active;
                               }
                            });
                        });
                        model.hideModal();
                    }
                    else {
                        var match = ko.utils.arrayFirst(model.round_config(), function (item) {
                            return parseInt(roundPk) == item.pk();
                        });

{#                        Create API to create RoundConfig and return the created roundConfig is JSON format and then add to the DOM #}
{#                        match.children.push(jsonObject);#}
                    }
                }
                model.saveRoundConfig = function(form) {

                    var form = $(form);
                    var update = form.find("input[type='hidden']").val();
                    var formData = form.serialize();

                    if (update) {
                        var match = ko.utils.arrayFirst(model.round_config(), function (item) {
                            return parseInt(update) === item.pk();
                        });
                        $.ajax("/api/configuration/round/"+ update, {
                            data: formData + '&request_type=update',
                            type: "POST",
                            success: function(result) {
                                if(result.success){
                                    var old_sequence_number = match.sequence_number();
                                    var new_sequence_number = match.sequence_number.updateValue();
                                    console.log(old_sequence_number);
                                    console.log(new_sequence_number);

                                    $.each(model.round_config(), function() {
                                        var current_sequence_number = this.sequence_number();
                                        if( current_sequence_number > old_sequence_number && current_sequence_number <= new_sequence_number){
                                            this.sequence_number(current_sequence_number - 1);
                                            this.sequence_number.commit();
                                        } else if( current_sequence_number >= new_sequence_number && current_sequence_number <= old_sequence_number){
                                            this.sequence_number(current_sequence_number + 1);
                                            this.sequence_number.commit();
                                        }
                                    });
                                    match.update(result.round_config);
                                    model.round_config(model.round_config().sort(function(left, right) { return left.sequence_number() < right.sequence_number() ? -1 : 1 }));
                                    model.hideModal();
                                }
                            }
                        });
                    }
                    else {
                        var experiment_config_pk = parseInt($('#experiment_config_pk').text())
                        formData += '&experiment_config_pk=' + experiment_config_pk;

                        $.ajax("/api/configuration/round/-1", {
                            data: formData + '&request_type=create',
                            type: "POST",
                            success: function(result) {
                                if(result.success){
                                    var new_sequence_number = result.round_config.sequence_number;
                                        $.each(model.round_config(), function() {
                                            var current_sequence_number = this.sequence_number();
                                            if( current_sequence_number >= new_sequence_number){
                                                this.sequence_number(current_sequence_number + 1);
                                                this.sequence_number.commit();
                                            }
                                        });
                                    model.round_config.push(new NodeModel(result.round_config));
                                    model.round_config(model.round_config().sort(function(left, right) { return left.sequence_number() < right.sequence_number() ? -1 : 1 }));
                                    model.hideModal();
                                }
                            }
                        });
                    }
                }

                model.saveExpParam = function(form) {
                    var form = $(form);
                    var update = parseInt(form.find("input[type='hidden']").val());
                    var jsonObject  = form.serializeObject();

                    var httpVerb = !update ? "POST" : "PUT";

                    if (update) {
                        var match = ko.utils.arrayFirst(model.experiment_param_val(), function (item) {
                            return parseInt(update) == item.pk();
                        });
                        model.hideModal();
                    }
                    else {
{#                      Create API to create RoundConfig and return the created roundConfig is JSON format and then add to the DOM #}
                        model.experiment_param_val.push({'display_name': jsonObject.parameter});
                        model.hideModal();
                    }
                }
                return model;
            };

            var pageModel = new PageModel(JSONdata);

            function ParamViewModel(data, parameter_list) {
                var self = this;

                self.parameter_list = ko.observable(parameter_list);

                self.pk = ko.observable(data.pk);
                self.parent_pk = ko.observable(data.parent_pk);
                self.selectedParameterPk = ko.observable(data.parameter_pk);
                self.stringValue = ko.observable(data.string_value);
                self.intValue = ko.observable(data.int_value);
                self.floatValue = ko.observable(data.float_value);
                self.booleanValue = ko.observable(data.boolean_value);
                self.isActive = ko.observable(data.is_active);

                self.parameterType = ko.observable(data.parameter_type);

                self.isVisible = function(types){
                    var typeList = types.split(',');
                    for(var index in typeList) {
                        if(typeList[index] === self.parameterType()) {
                            return true;
                        }
                    }
                    return false;
                };
                self.selectedParameterPk.subscribe(function (data) {

                    ko.utils.arrayForEach(self.parameter_list(), function(param){

                        if (param.pk() === data){
                            self.parameterType(param.type());
                            self.selectedParameterPk(param.pk());
                        }
                    });
                });
            }

            ko.bindingHandlers.showModal = {
                init: function (element, valueAccessor) {
                    $(element).on('hidden', function () {
                        var value = valueAccessor();
                        value(false);
                    });
                    $(element).on('shown'), function () {
                        var value = valueAccessor();
                        value(true);
                    }
                },
                update: function (element, valueAccessor) {
                    var value = valueAccessor();
                    if (ko.utils.unwrapObservable(value)) {
                        $(element).modal('show');
                        // this is to focus input field inside dialog
                        $("input", element).focus();
                    }
                    else {
                        $(element).modal('hide');
                    }
                }
            };

            ko.bindingHandlers.slideVisible = {
                init: function(element, valueAccessor) {
                    // Initially set the element to be instantly visible/hidden depending on the value
                    var value = valueAccessor();
                    $(element).toggle(ko.unwrap(value)); // Use "unwrapObservable" so we can handle values that may or may not be observable
                },
                update: function(element, valueAccessor) {
                    // Whenever the value subsequently changes, slowly fade the element in or out
                    var value = valueAccessor();
                    ko.unwrap(value) ? $(element).slideDown(200) : $(element).slideUp(200);
                }
            };

            $.fn.serializeObject = function() {
                var o = {};
                var a = this.serializeArray();
                $.each(a, function() {
                    if (o[this.name] !== undefined) {
                        if (!o[this.name].push) {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
                return o;
            };

            ko.applyBindings(pageModel);

        });

    </script>

{% endblock javascript %}
