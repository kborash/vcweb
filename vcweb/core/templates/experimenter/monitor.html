{% extends "experimenter/base.html" %}
{% block title %}
#{{ experiment.pk }}: {{ experiment.experiment_metadata }}
{% endblock %}
{% block page %}
{{block.super}}
<h3>{{experiment}}</h3>
<div class='row-fluid'>
    <div class='span6'>
        <ul class='nav nav-list' data-bind="if: isActive">
            <li class='nav-header'>round management</li>
            <li><a class='confirm' name='advance_to_next_round' href='javascript:void()' data-content='Stops the current round if necessary and advances to the next round.'><i class='icon-step-forward'></i>advance to next round</a></li>
            <li data-bind="ifnot: isRoundInProgress"><a class='confirm' name='start_round' href='start-round' data-content='Starts the round.'><i class='icon-play'></i>start round</a></li>
            <li data-bind="if: isRoundInProgress"><a class='confirm' name='end_round' href='end-round' data-content='Stops the current round.'><i class='icon-stop'></i>end round</a></li>
            <li><a href='javascript:void();' id='refreshAllParticipants' data-content='Sends a page refresh to all connected participants.' ><i class='icon-refresh'></i>refresh all participants</a></li>
            <li class='divider'></li>
            <li class='nav-header'>download data</li>
            <li><a href='download/csv'><img src='{{STATIC_URL}}images/famfamfam/page_white_text.png' style='margin: 5px 0 0 0;' alt='' />csv</a></li>
            <li><a href='download/xls'><img src='{{STATIC_URL}}images/famfamfam/page_white_excel.png' style='margin: 5px 0 0 0;' alt=''/>xls</a><li>
        </ul>
        <div data-bind="ifnot: isActive">
            <div data-bind="ifnot: hasParticipants()">
                <div class='alert alert-error alert-block'>
                    <i class='icon-warning-sign'></i>There are no registered participants. You can <a href='{{experiment.controller_url}}/register-email-list'>register email addresses for participants</a> or 
                    <a href='{{experiment.controller_url}}/register-simple'>add test participants</a>
                </div>
            </div>
            <div data-bind="if: hasParticipants()">
                <div class='alert alert-info alert-block'>
                    This experiment is currently inactive.  Please activate the experiment
                    after you have registered all participants and are ready to start the experiment run. You have registered <span data-bind='text:participantCount'
                        class='badge badge-info' data-content='{{experiment.participant_set}}'></span> participants.
                </div>
                <ul class='nav nav-list'>
                    <li><a data-content='Activate an experiment after you have registered participants and are ready to start it.' 
                        class='confirm' name='activate' href='activate'><i class='icon-off'></i>activate</a></li>
                </ul>
            </div>
        </div>
        <ul class='nav nav-list'>
            <li class='nav-header'>round status</li>
            <li data-content='{{experiment.actions_help_text}}'><span data-bind='text:roundSequenceLabel'></span>, <span data-bind='text:roundStatusLabel'></span></li>
            <li>Experiment started on: <span data-bind='text:currentRoundStartTime'></span></li>
            <li>Time remaining: <span data-bind='text:timeRemaining'></span></li>
            <li>Registered participants: <span data-bind='text:participantCount' class='badge badge-info'></span></li>
        </ul>
    </div>
    <div class='span6'>
        <h4>Experiment Log</h4>
        <div id='experiment-messages' class='alert' data-bind='foreach: messages'>
            <div>
                <button class='close' data-dismiss='alert'>&times;</button>
                <span data-bind='text: $data'></span>
            </div>
        </div>
    </div>
</div>
<h3>Experiment Data</h3>
<div class='accordion' id='round-data-accordion' data-bind='foreach: allRoundData'>
    <div class='accordion-group'>
        <div class='accordion-heading'>
            <a class='accordion-toggle' data-toggle='collapse' data-parent='#round-data-accordion' 
                data-bind='attr: { href: "#" + roundDataId() }'>
                <span class='label label-success' data-bind='text: roundType'></span>Round <span data-bind='text: roundNumber'></span></a>
        </div>
        <div data-bind='attr: { id: roundDataId }' class='accordion-body collapse'>
            <div class='accordion-inner'>
                <table class='table table-striped table-bordered'>
                    <caption>Group data</caption>
                    <thead>
                        <tr><th>Group</th><th>Parameter</th><th>Value</th></tr>
                    </thead>
                    <tbody data-bind='foreach: groupDataValues'>
                    <tr>
                        <td data-bind='text: group'></td>
                        <td data-bind='text: parameter'></td>
                        <td data-bind='text: value'></td>
                    </tr>
                    </tbody>
                </table>
                <table class='table table-striped table-bordered'>
                    <caption>Participant data</caption>
                    <thead>
                        <tr><th>Participant</th><th>Parameter</th><th>Value</th></tr>
                    </thead>
                    <tbody data-bind='foreach: participantDataValues'>
                    <tr>
                        <td data-bind='text: participantLabel'></td>
                        <td data-bind='text: parameter'></td>
                        <td data-bind='text: value'></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class='accordion' id='experiment-chat-accordion'>
    <div class='accordion-group'>
        <div class='accordion-heading'>
            <a class='accordion-toggle' data-toggle='collapse' data-parent='#experiment-chat-accordion' href='#experiment-chat-messages'>All Chat Messages</a>
        </div>
        <div id='experiment-chat-messages' class='scrollable-messages accordion-body collapse'>
            <div data-bind='foreach: chatMessages'>
                <div class='alert alert-message' data-bind='text: $data'></div>
            </div>
        </div>
    </div>
</div>
{% endblock page %}
{% block javascript %}
{{ block.super }}
{% include "includes/experimenter.events.html" %}
{% include "includes/sockjs.html" %}
<script type='text/javascript'>
    var experimentModelJson = $.parseJSON("{{ experiment.to_json|escapejs }}");
    $(function() {
        function ExperimentModel (experimentModelJson) {
            var self = this;
            var model = ko.mapping.fromJS(experimentModelJson);
            model.addMessage = function (evt) {
                model.messages.unshift(evt.message);
            }
            model.hasParticipants = function() {
                console.log("participant count: " + model.participantCount());
                return model.participantCount() > 0;
            }
            return model;
        }
        function update(experimentModel) {
            return function(data) {
                ko.mapping.fromJS(data, experimentModel);
            }
        }
        function initialize(experimentModelJson) {
            var experimentModel = new ExperimentModel(experimentModelJson);
            // var experimentModel = new ExperimentModel();
            ko.applyBindings(experimentModel);
            // establish sockjs websocket connection
            var s = connect("/experimenter");
            s.onmessage = function(evt) {
                console.log("Received event: " + evt);
                experimentModel.addMessage(jQuery.parseJSON(evt.data));
            };
            $('a.confirm').live("click", function(evt) {
                evt.preventDefault();
                var self = $(this);
                var description = self.attr("data-content");
                var action = self.attr("name");
                bootbox.confirm(description + "  Continue?", function(confirmed) {
                    if (confirmed) {
                        Dajaxice.vcweb.core.experiment_controller(update(experimentModel), {'pk': {{experiment.pk}}, 'action':action});
                    }
                    return false;
                });
            });
            $('#refreshAllParticipants').click(function(evt) {
                evt.preventDefault();
                // FIXME: replace with sendRefreshEvent()
                getWebSocket().send(createRefreshEvent());
                return false;
            });
            $('#transitionAllParticipants').click(function(evt) {
                console.log("sending goto event");
                // FIXME: replace with sendGotoEvent()
                getWebSocket().send(createGotoEvent());
                return false;
            });
        }
        $('[data-content]').popover();
        // initialize experiment model JSON from experiment model
        initialize(experimentModelJson);
    });
</script>
{% endblock %}
