{% extends "experimenter/base.html" %}
{% block title %}Virtual Commons Web Experimenter Dashboard{% endblock %}
{% block page %}
{{ block.super }}
<h2>Experimenter Dashboard</h2>
{% comment %} FIXME: UI refinement needed as the list of experiments grows {% endcomment %}
<div id='dashboard'>
    <ul class='nav nav-tabs'>
        <li class='active'><a href='#start' data-toggle='tab'><i class='icon-beaker'></i> Start a new experiment</a></li>
        <li><a href='#manage' data-toggle='tab'><i class='icon-wrench'></i> Manage running experiments</a></li>
        <li><a href='#archived' data-toggle='tab'><i class='icon-archive'></i> Archived experiments</a></li>
    </ul>
    <div class='tab-content'>
        <div class='tab-pane active' id='start'>
            <div data-bind='foreach: experimentMetadataList'>
                <h3><span data-bind='text: title'></span> Configurations</h3>
                <div data-bind='foreach: configurations'>
                    <div class='alert alert-message'>
                        <h4><span data-bind='text: name'>configuration name</span> (treatment id: <span data-bind='text: treatment_id() || "None"'></span>) <span class='pull-right' data-bind='text: date_created'></span></h4>
                        <span data-bind='text: number_of_rounds'></span> rounds, groups of <span data-bind='text: max_group_size'></span>
                        <br>
                        <div class='btn-group'>
                            <a class='btn' data-bind='click: $root.createNewExperiment.bind($data)'><i class='icon-plus-sign'></i> start new experiment</a>
                            <a class='btn' data-bind='click: $root.modify'><i class='icon-edit'></i> edit configuration</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class='tab-pane' id='manage'>
            <div data-bind='foreach: runningExperiments'>
                <h4><span data-bind='text: status_line'></span> <span class='pull-right'><span data-bind='text: participantCount' class='badge badge-important'></span> participants</span></h4>
                <div class='btn-group'>
                    <a class='btn' data-bind='attr: { href: monitor_url }'><i class='icon-zoom-in'></i> monitor</a>
                    <a class='btn confirm-experiment-action' data-content='Creates a new copy of this experiment with the same configuration and no participants.'
                        data-bind='click: $root.cloneExperiment'><i class='icon-copy'></i> clone</a>
                    <span data-bind='if: $root.canRegisterParticipants($data)'>
                        <a class='btn' data-content='Register participants for this experiment with actual email addresses' href='{{e.controller_url}}/register-email-list'>
                            <img src='{{STATIC_URL}}images/famfamfam/group_add.png' alt='register'/> register participants</a>
                        <a data-content='Register participants for this experiment with fake email addresses by providing an email suffix and the number of participants.' 
                            class='btn' href='{{e.controller_url}}/register-test-participants'>
                            <img src='{{STATIC_URL}}images/famfamfam/group_add.png' alt='register'/> test participants</a>
                    </span>
                    {% comment %}
                    FIXME: update to KO logic
                    {% if not e.is_archived %}
                    {% if e.participant_set.count == 0  %}
                    <a class='btn' data-content='Register participants for this experiment with actual email addresses' href='{{e.controller_url}}/register-email-list'>
                        <img src='{{STATIC_URL}}images/famfamfam/group_add.png' alt='register'/> register participants</a>
                    <a data-content='Register participants for this experiment with fake email addresses by providing an email suffix and the number of participants.' 
                        class='btn' href='{{e.controller_url}}/register-test-participants'>
                        <img src='{{STATIC_URL}}images/famfamfam/group_add.png' alt='register'/> test participants</a>
                    {% else %}
                    <a data-content='Remove all participants from the experiment, including any data they may have generated.' href='{{e.controller_url}}/clear-participants' class='btn confirm-experiment-action'>
                        <i class='icon-trash'></i> clear all participants</a>
                    {% endif %}
                    {% if e.is_active %}
                    <a data-action='complete' data-content='Mark this experiment as completed' href='{{e.complete_url}}' class='btn confirm-experiment-action'><i class='icon-save'></i> archive</a>
                    <a data-action='deactivate' data-content='deactivate this experiment' href='{{e.deactivate_url}}' class='btn confirm-experiment-action'><i class='icon-off'></i> deactivate</a>
                    {% else %}
                    <a class='btn' data-content='Configure this experiment' href='{{e.configure_url}}'><i class='icon-wrench'></i> configure</a>
                    {% endif %}
                    {% endif %}
                    {% endcomment %}
                </div>
            </div>
        </div>
        <div class='tab-pane' id='archived'>
            <div data-bind='if: archivedExperiments().length == 0'>
                No archived experiments.
            </div>
            <div data-bind='foreach: archivedExperiments'>
                <h4><span data-bind='text: status_line'></span> <span class='pull-right'><span data-bind='text: participantCount' class='badge badge-important'></span> participants</span></h4>
                <div class='btn-group'>
                    <a class='btn' data-bind='attr: { href: monitor_url }'><i class='icon-zoom-in'></i> monitor</a>
                    <a class='btn confirm-experiment-action' data-content='Creates a new copy of this experiment with the same configuration and no participants.'
                        data-bind='click: $root.cloneExperiment'><i class='icon-copy'></i> clone</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock page %}
{% block javascript %}
{{ block.super }}
<script type='text/javascript'>
    var dashboardViewModelJson = $.parseJSON("{{ dashboardViewModelJson|escapejs }}");
    $(function() {
        function DashboardViewModel(dashboardViewModelJson) {
            var self = this;
            var model = ko.mapping.fromJS(dashboardViewModelJson);
            model.createNewExperiment = function(configurationModel) {
                console.debug("create new experiment from configuration");
                console.debug(configurationModel);
                Dajaxice.vcweb.core.create_experiment(function(data) {
                    if (data.success) {
                        console.debug("created new experiment: ");
                        console.debug(data);
                    }
                },
                { experiment_configuration_id: configurationModel.pk() });

            }
            model.modify = function() {
                console.debug("modify existing configuration");
            }
            model.cloneExperiment = function() {
                console.debug("cloning experiment");
            }
            model.canRegisterParticipants = function(experimentModel) {
                return ! experimentModel.isArchived() && experimentModel.participantCount() === 0;
            }

            return model;
        }
        var model = new DashboardViewModel(dashboardViewModelJson);
        ko.applyBindings(model);
        $('a.confirm-experiment-action').on("click", function(evt) {
            evt.preventDefault();
            var self = $(this);
            var description = self.attr("data-content");
            var href = self.attr("href");
            if (self.hasClass('disabled')) {
                console.debug("disabled action " + action + " - ignoring");
                return false;
            }
            bootbox.confirm(description + "  Continue?", function(confirmed) {
                if (confirmed) {
                    window.location = self.attr("href");
                }
            });
            return false;
        });
    });
</script>
{% endblock %}

