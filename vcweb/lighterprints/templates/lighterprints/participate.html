{% extends "participant/base.html" %}
{% block head %}
{{ block.super }}
<link rel='stylesheet' href='{{STATIC_URL}}/css/lighterprints/style.css'/>
<link rel="stylesheet" href="//fast.fonts.com/cssapi/e86344be-530a-495b-be28-7a22a9cda219.css"/>
{% endblock %}
{% block headerlinks %}
<ul class='nav nav-tabs' id='lfp-navtabs'>
    <li><a class='brand'><img alt='footprint logo' src='{{STATIC_URL}}/images/lighterprints/logo.png' width=30 height=30> lighter<strong class='lighterprints-green'>footprints</strong></a></li>
    <li class='active'><a href='#dashboard' data-toggle='tab'><i class='icon-dashboard'></i> Dashboard</a></li>
    <li><a href='#challenges' data-toggle='tab'><i class='icon-star-empty'></i> Challenges</a></li>
    <li><a href='#group-wall' data-toggle='tab'><i class='icon-comments-alt'></i> My Team</a></li>
    <li><a href='#help' data-toggle='tab'><i class='icon-question-sign'></i> Help</a></li>
</ul>
{% endblock %}
{% block logo %}
{% endblock %}
{% block content %}
<div class='tabbable'>
    <div class='tab-content'>
        <div class='tab-pane active' id='dashboard'>
            <h1 class='dashboard-header muted'><i class='icon-dashboard'></i> Team Dashboard</h1>
            <!-- FIXME: re-enable this at some point
            <div data-bind='if: firstVisit()'>
            -->
            <div class='alert alert-block alert-white'>
                <button type="button" class="close" data-dismiss="alert"><i class='icon-remove-sign'></i></button>
                <h2 class='muted'>Welcome to Lighter Footprints, <i class='lighterprints-blue'><span data-bind='text: groupName'></span>!</i></h2>
                <p>
                    You have been randomly placed in a group of {{ participant_group_relationship.group.size }}
                    participants. In this experiment you can perform virtual actions that represent green alternatives
                    to some common daily activities.
                </p>
                <p>
                    <i class='lighterprints-green icon-leaf'></i> Earn <span style='background-color: #66CC00; color: #FFFFFF;' class='label'>green points</span> by
                    completing challenges.  Rank up by <b>increasing your team's average score.</b>.
                </p>
                <p>
                    <i class='icon-star text-warning'></i> Some challenges are unlocked all day, and others are only
                    unlocked at specific times.  Discover new challenges by ranking up!
                </p>
                <p>
                    <strong>Your point totals reset at midnight each night.</strong>  If your group's average score
                    isn't high enough to rank up, you must start over.
                </p>
            </div>
            <!-- FIXME: disabled conditional instruction message
            </div>
            -->
            <div class='row lighterprints-scoreboard'>
                <div class='span2'>
                    <h5>Today's Score</h5>
                    <table>
                        <tr>
                            <td class='lighterprints-scoreboard-xlarge'><span data-bind='text: averagePoints'></span></td>
                            <td><i class='lighterprints-green icon-leaf icon-2x'></i></td>
                        </tr>
                    </table>
                </div>
                <div class='span2 left-divider'>
                    <h5>Current Level</h5>
                    <h1><span data-bind='text: groupLevel'></span></h1>
                    <br>
                </div>
                <div class='span2 left-divider'>
                    <h5>Today's Progress</h5>
                    <h1><span data-bind='text: averagePoints'></span> / <span data-bind='text:pointsToNextLevel'></span></h1>
                    <br>
                </div>
                <div class='span2 left-divider'>
                    <h5>Time Remaining</h5>
                    <h1><span data-bind='text:hoursLeft'></span>h <span data-bind='text:minutesLeft'></span>m</h1>
                    <br>
                </div>
            </div>
            <h3>Challenges</h3>
            <div class='tabbable'>
                <ul class='nav nav-tabs'>
                    <li class='active'><a href='#unlocked-challenges' data-toggle='tab'><i class='icon-star text-warning'></i> Unlocked</a></li>
                    <li><a href='#locked-challenges' data-toggle='tab'><i class='icon-lock'></i> Locked</a></li>
                </ul>
                <div class='tab-content'>
                    <div class='tab-pane active' id='unlocked-challenges'>
                        <div data-bind="template: { name: 'challenges-template', data: { challenges: unlockedChallenges() } }"></div>
                    </div>
                    <div class='tab-pane' id='locked-challenges'>
                        <div data-bind="template: { name: 'challenges-template', data: { challenges: lockedChallenges() } }"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class='tab-pane' id='challenges'>
            <h2>All Challenges</h2>
            <p>
            Challenges are divided up into 3 levels.  In order to unlock higher level challenges your group must earn
            enough points so that the <strong>average number of points</strong> per participant is greater than
            <span data-bind='text:pointsToNextLevel' class='badge badge-info'></span>.
            </p>
            <p>
            Some challenges are available all day, and others are only available at <strong>certain hours</strong>.
            </p>
            <div data-bind='foreach: activitiesByLevel'>
                <h2>Level <span data-bind='text: $index() + 1'></span> challenges</h2>
                <div data-bind='template: { name: "challenges-template", data: { challenges: $data } }'></div>
            </div>
        </div>
        <div class='tab-pane' id='help'>
            <h2>Instructions</h2>
            <p>
            You have been randomly placed in a group of <span class='badge badge-info'>{{ participant_group_relationship.group.size }}</span> participants.
            In this experiment you can perform virtual actions that represent <span class='text-success'>green alternatives</span>
            to some common daily activities.  Some of these activities are available all day, and others are only available at
            specific times.  You can learn more about them by clicking on the <a href='#challenges' data-bind='click: activateChallengesTab'>Challenges tab</a> and selecting an activity.
            </p>
            <h3>Activities, Green Points, and Levels</h3>
            <p>
            Each activity is worth a certain number of green points.  For example, <span class='text-success'>eating locally grown food for lunch</span> (which is only available from 12 PM to 2 PM) is worth <span class='badge badge-success'>15</span> green points.
            In order to perform this activity you must login to the application between 12 PM and 2 PM, select the activity from the
            list below, and click the "Perform this activity" button.
            </p>
            <p>
            Your group is currently <span class='badge badge-important'>level <span data-bind='text:groupLevel'></span></span> and has accumulated 
            <span class='badge badge-important'><span data-bind='text:averagePoints'></span> average points</span>.  In order to
            advance in level and unlock more activities the <strong>average number of points contributed by each member of your group</strong> must be equal to or greater than 
            <span data-bind='text: pointsToNextLevel' class='badge badge-info'></span>.  In order to
            reach this target <span class='text-warning'>you and a majority of the members of your group</span> must perform
            high point activities when they are available.
            </p>
            <h3>How to participate</h3>
            <p>
            To participate, simply click on the <a href='#challenges' data-bind='click: activateChallengesTab'>Challenges tab</a>, and select an activity you'd like to perform.
            You can also leave messages for your other teammates in the My Team tab.
            </p>
            <h2>Frequently Asked Questions</h2>
            <div class='well'>
                <h4>Why do the activities performed in the previous day not count for today?</h4>
                <p>
                In order to advance in level and unlock more activities you must reach an average level of points in your
                group during one day, starting at 0.00AM.  Every day at midnight the server will check your group's average number of
                points and determine whether or not you should move on to the next level.
                If your group advances in level your group will once again start at 0 points with the additional unlocked
                activities for that level available to perform. If your group did not reach the next level, your group
                will start with 0 points at the same level with the same activities available as the previous day.
                </p>
            </div>
            <div class='well'>
                <h4>I don't have a car or anyone to carpool with, so how can I carpool?</h4>
                <p>
                You don't have to actually perform the activity in the real world to click on "perform this activity" -
                these are just virtual activities at the moment. In the future we plan to include options to gain points by
                actually performing these activities.
                </p>
            </div>
        </div>
        <div class='tab-pane' id='group-wall'>
            <h3>Chat messages</h3>
            <form id='chat-form' class='form-horizontal' data-bind='submit: submitChatMessage'>
                <input type='hidden' name='participant_group_id' value='{{participant_group_relationship.id}}'/>
                <div class='control-group'>
                    <label class='control-label' for='chatText'>Chat</label>
                    <div class='controls'>
                        <input type='text' id='chatText' name='message' placeholder='Send a message to your group' />
                    </div>
                </div>
                <div class='control-group'>
                    <div class='controls'><a class='btn' data-bind='click: submitChatMessage'>Send</a></div>
                </div>
            </form>

            <div id='chat-div' class='scrollable-messages'>
                <div data-bind='ifnot: hasChatMessages() '>
                    <div class='alert alert-warning'>
                        No chat messages have been posted yet.
                    </div>
                </div>
                <div data-bind='if: hasChatMessages()'>
                    <div data-bind='foreach: chatMessages'>
                        <div class='alert alert-message chat-message'>
                            <strong data-bind='text: participant_name'></strong>: <em><span data-bind='text: message'></span></em>
                            <b class='pull-right' ><span data-bind='text: date_created'></span> ago</b>
                        </div>
                    </div>
                </div>
            </div>
            <h3>Recent activity</h3>
            <div data-bind='foreach: groupActivity' class='scrollable-messages'>
                <div class='alert alert-info'>
                    <span data-bind='text: participant_name'></span> performed <span data-bind='text: display_name'></span>,
                    earning <span class='badge badge-success' data-bind='text:points'></span> green points.
                    <b class='pull-right'><span data-bind='text: date_created'></span> ago</b>

                </div>
            </div>
        </div>
    </div>
</div>
<div id='activityUnavailableModal' class='modal hide fade' tabindex='-1' role='dialog'
    aria-labelledby='activityUnavailableModalLabel'
    aria-hidden='true'>
    <div class='modal-header'>
        <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>x</button>
        <h3 id='activityUnavailableModalLabel'>Unable to perform activity</h3>
    </div>
    <div class='modal-body'>
        <div class='alert alert-error'>
            <span class='text-error' data-bind='text:errorMessage'></span>
        </div>
    </div>
    <div class='modal-footer'>
        <button class='btn' data-dismiss='modal' aria-hidden='true'>Continue</button>
    </div>
</div>
<div id='activityPerformedModal' class='modal hide fade' tabindex='-1' role='dialog'
    aria-labelledby='activityPerformedModalLabel'
    aria-hidden='true'>
    <div class='modal-header'>
        <h3 id='activityPerformedModalLabel'>Performing activity</h3>
    </div>
    <div class='modal-body'>
        <div class="progress progress-striped active">
            <div class="bar" style="width: 100%;"></div>
        </div>
        <p id='activityPerformedModalText' class='hide'>
        You have successfully performed <span class='text-success' data-bind='text:lastPerformedActivity'></span>,
        earning <span class='badge badge-success' data-bind='text: lastPerformedActivityPoints'></span> green points for
        your group.
        </p>
    </div>
    <div class='modal-footer'>
        <button class='btn disabled' data-dismiss='modal' aria-hidden='true'>Continue</button>
    </div>
</div>
{% endblock content %}
{% block sidebar %}
<h3 class='muted'><i class='text-warning icon-trophy'></i> Leaderboard</h3>
<ul class='nav nav-list' data-bind='foreach: groupData'>
    <li><strong>#<span data-bind='text:$index() + 1'></span></strong> <span data-bind='css: { "bold text-info": groupName() == $root.groupName()}'><span data-bind='text: groupName'></span></span><span class='pull-right badge badge-success' data-bind='text: averagePoints'></span></li> 
    <li class='divider'></li>
</ul>

<h3 class='muted'><i class='lighterprints-blue icon-group'></i> Team Activity <span class='pull-right'><small><a href='#group-wall' data-toggle='tab'>View all</a></small></span></h3>
<ul class='nav nav-list' data-bind='foreach: groupActivity.slice(0, 3)'>
    <li>
    <table>
        <tr>
            <td style='vertical-align: top'><i class='icon-star text-warning'></i></td>
            <td style='vertical-align: top'>
                <strong data-bind='text: participant_name'></strong>
                <small class='pull-right muted'><span data-bind='text: date_created'></span></small>
                <div>earned <span class='lighterprints-green' data-bind='text:points'></span><i class='icon-leaf lighterprints-green'></i>
                    for <span data-bind='text: $root.groupName'></span> by completing <em><span data-bind='text: display_name'></span></em>.
                </div>
            </td>
        </tr>
    </table>
    </li>
    <li class='divider'></li>
</ul>
<ul class='nav nav-list' data-bind='foreach: chatMessages.slice(0, 3)'>
    <li>
    <table>
        <tr>
            <td style='vertical-align: top'><i class='icon-comment lighterprints-blue'></i></td>
            <td width='100%'>
                <strong data-bind='text: participant_name'></strong>
                <small class='pull-right muted'><span data-bind='text: date_created'></span></small>
                <p>
                <i class='icon-quote-left'></i>
                <span data-bind='text:message'></span>
                <i class='icon-quote-right'></i>
                </p>
            </td>
        </tr>
    </table>
    </li>
    <li class='divider'></li>
</ul>


{% endblock sidebar %}
{% block javascript %}
{{ block.super }}
<script src="//fast.fonts.com/jsapi/e86344be-530a-495b-be28-7a22a9cda219.js"></script>
<script type='text/javascript' src='{{STATIC_URL}}js/lighterprints/model.js'></script>
<script type='text/javascript'>
$(function() {
    // XXX: set up bootstrap nav-tabs to be semi-refresh friendly, remove in production
    /*
    var url = document.location.toString();
    if (url.match('#')) {
        $('.nav-tabs a[href=#'+url.split('#')[1]+']').tab('show');
    }
    $('.nav-tabs a').on('shown', function(evt) {
        window.location.hash = evt.target.hash;
    });
    */
    // set up KO binding, using one master view model
    var viewModelData = $.parseJSON("{{ view_model_json|escapejs }}");
    var viewModel = new LighterFootprintsModel(viewModelData);
    viewModel.activateChallengesTab = function() {
        $('#lfp-navtabs a[href="#challenges"]').tab('show');
    };
    viewModel.perform = function(challengeModel) {
        if (! challengeModel.availableNow()) {
            // FIXME: modal is slow, no feedback on this for now
            // model.errorMessage("The activity " + activityModel.display_name() + " is not currently available.");
            // $('#activityUnavailableModal').modal();
            return;
        }
        // FIXME: feels dirty
        $('#activityPerformedModal .progress').removeClass('hide');
        $('#activityPerformedModalText').addClass('hide');
        $('#activityPerformedModal .btn').addClass('disabled');
        $('#activityPerformedModal').modal();
        var activityId = challengeModel.pk();
        var formData = $('#activityform' + activityId).serialize();
        $.post('/lighterprints/api/do-activity', formData, function(data) {
                if (data.success) {
                    ko.mapping.fromJSON(data.viewModel, viewModel);
                    console.debug("successfully performed activity");
                    viewModel.lastPerformedActivity(challengeModel.display_name());
                    viewModel.lastPerformedActivityPoints(challengeModel.points());
                    // FIXME: hacky
                    $('#activityPerformedModal .progress').addClass('hide');
                    $('#activityPerformedModalText').removeClass('hide');
                    $('#activityPerformedModal .btn').removeClass('disabled');
                }
                else {
                    viewModel.errorMessage("Unable to perform activity: " + data.message);
                    $('#activityUnavailableModal').modal();
                }
            });
    };
    ko.applyBindings(viewModel);
});
</script>
<script type='text/html' id='challenges-template'>
<div data-bind='foreach: challenges'>
<div class='row'>
    <div class='span2'>
        <img data-bind='attr: {src: "{{STATIC_URL}}/images/lighterprints/badges/" + name() + ".png" }'>
    </div>
    <div class='span5'>
        <h4 data-bind='text:display_name'></h4>
        <p>
        <span data-bind='text:summary'></span>.
        </p>
        <form data-bind='attr: { id: "activityform" + pk() }' class='form-horizontal' method='post'>
            <input data-bind='value: pk' type='hidden' name='activity_id' />
            <input type='hidden' name='participant_group_id' value='{{participant_group_relationship.pk}}' />
            <a data-bind='css: status, click: $root.perform' class='btn'>
            <span data-bind='if: availableNow'>Perform</span>
            <span data-bind='if: completed'>Completed <i class='icon-check'></i></span>
            <span data-bind='if: expired'>Expired <i class='icon-warning-sign'></i></span>
            <span data-bind='if: upcoming'>Not yet available <i class='icon-time'></i></span>
            <span data-bind='if: locked'>Locked <i class='icon-lock'></i></span>
            </a> <small><a href='#'>Learn more</a></small>
        </form>
    </div>
    <div class='span2'>
        <i style='margin-top: 20px;' class='icon-leaf lighterprints-green pull-right'></i><h2 style='text-align: right;' class='lighterprints-scoreboard-large' data-bind='text: points'></h2>
        <div style='text-align: right;'><i class='icon-time'></i> <strong><span data-bind='text: time_slots'></span></strong></div>
    </div>
</div>
<hr>
</div>
</script>
{% endblock %}
