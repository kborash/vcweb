{% extends "lighterprints/base.html" %}
{% block logo %}
<h1>Welcome to the {{ experiment.display_name }} experiment</h1>
{% endblock %}
{% block page %}
<div class='tabbable'>
    <ul class='nav nav-tabs'>
        <li class='active'><a href='#instructions' data-toggle='tab'>Instructions</a></li>
        <li><a href='#group-wall' data-toggle='tab'>Group Wall</a></li>
        <li><a href='#group-score' data-toggle='tab'>Score</a></li>
        <li><a href='#all-activities' data-toggle='tab'>All activities</a></li>
        <li><a href='#faq' data-toggle='tab'>FAQ</a></li>
    </ul>
    <div class='tab-content'>
        <div class='tab-pane active' id='instructions'>
            <p>
            You have been randomly placed in a group of <span class='badge badge-info'>{{ participant_group_relationship.group.size }}</span> participants.
            In this experiment you can perform virtual actions that represent <span class='text-success'>green alternatives</span>
            to some common daily activities.  Some of these activities are available all day, and others are only available at
            specific times.  You can learn more about them by clicking on the "All Activities" tab and selecting an activity.
            </p>
            <h3>Activities, Green Points, and Levels</h3>
            <p>
            Each activity is worth a certain number of green points.  For example, <span class='text-success'>eating locally grown food for lunch</span> (which is only available from 12 PM to 2 PM) is worth <span class='badge badge-success'>15</span> green points.
            In order to perform this activity you must login to the application between 12 PM and 2 PM, select the activity from the
            list below, and click the "Perform this activity" button.
            </p>
            <p>
            Your group is currently <span class='badge badge-important'>level <span data-bind='text:groupLevel'>{{ group_level }}</span></span> and has accumulated 
            <span class='badge badge-important'><span data-bind='text:averagePoints'>{{average_points}}</span> average points</span>.  In order to
            advance in level and unlock more activities the <strong>average number of points contributed by each member of your group</strong> must be equal to or greater than <span data-bind='text: pointsToNextLevel' class='badge badge-info'>{{points_to_next_level}}</span>.  In order to
            reach this target <span class='text-warning'>you and a majority of the members of your group</span> must perform
            high point activities when they are available.
            </p>
            <h3>How to participate</h3>
            <p>
            To begin participating, click on the "All activities" tab, and select an activity you'd like to perform.
            Available activities will be marked with an exclamation point: <i class='icon-exclamation-sign'></i>
            </p>
            <div data-bind='if: hasAvailableActivities()'>
                <h3>Available activities for {{request.user.participant}}</h3>
                <ul data-bind='foreach: availableActivities()'>
                    <li data-bind='text: display_name'></li>
                </ul>
            </div>
            <div data-bind='ifnot: hasAvailableActivities()'>
                <div class='alert alert-error'>
                    <i class='icon-info-sign'></i>
                    There are no available activities at this time.  Please try again later.
                </div>
            </div>
        </div>
        <div class='tab-pane' id='all-activities'>
            <p>
            Activities are divided up into 3 levels.  In order to unlock higher level activities your group must earn
            enough points so that the <strong>average number of points</strong> per participant is greater than
            <span data-bind='text:pointsToNextLevel' class='badge badge-info'></span>.
            </p>
            <p>
            Currently available activities are marked with a <i class='icon-exclamation-sign'></i>.  You can click on
            any activity's name to learn more information about it.
            </p>
            {% comment %} FIXME: rewrite this to use KO instead of django templating if possible {% endcomment %}
            <div data-bind='foreach: activitiesByLevel'>
                <div class='accordion' data-bind='attr: {id: "accordion-level" + $index()}'>
                    <h4>Level <span data-bind='text: $index() + 1'></span> Activities</h4>
                    <div data-bind='foreach: $data'>
                        <div class='accordion-group alert alert-message'>
                            <div class='accordion-heading'>
                                <a class='accordion-toggle' data-toggle='collapse'
                                    data-bind='attr: {"data-parent": "#accordion-level" + $parentContext.$index(), href: "#activity" + pk()}'><i class='icon-chevron-right'></i>
                                    <span data-bind='text: display_name'></span>
                                    <span class='pull-right text-info'>
                                        <span data-bind='if: available_now'>
                                            <i class='icon-exclamation-sign'></i>
                                        </span>
                                        <span data-bind='text: time_slots'></span>
                                    </span>
                                </a>
                            </div>
                            <div data-bind='attr: {id: "activity" + pk()}' id='activity{{activity.pk}}' class='accordion-body collapse'>
                                <div class='accordion-inner'>
                                    <table class='table table-condensed table-bordered table-striped'>
                                        <thead>
                                            <tr><th>Summary</th><th>Availability</th><th>Points</th></tr>
                                        </thead>
                                        <tbody>
                                        <tr><td data-bind='text: summary'></td><td><span data-bind='text: time_slots' class='text-info'></span></td><td><span data-bind='text: points' class='badge badge-success'></span></td></tr>
                                    </table>
                                    <p data-bind='text: description'></p>
                                    <p>For more info, please visit <a data-bind='text: url, attr: { href: url }' target="_blank"></a></p>
                                    <div data-bind='ifnot: available_now'>
                                        <div class='alert alert-error'>
                                            <i class='icon-warning-sign'></i>This activity is not available right now.  Please check again later.
                                        </div>
                                    </div>
                                    <form data-bind='attr: { id: "activityform" + pk() }' class='form-horizontal' method='post' id='activityform{{activity.pk}}'>
                                        <input data-bind='value: pk' type='hidden' name='activity_id' />
                                        <input type='hidden' name='participant_group_id' value='{{participant_group_relationship.pk}}' />
                                        <a data-bind='click: $root.performActivity' class='btn activity-action'
                                            href='#'><span class='text-success'> Perform this activity</span></a>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class='tab-pane' id='group-score'>
            <h3>Group Score Summary</h3>
            Your group is currently <span class='badge badge-important'>level <span data-bind='text:groupLevel'>{{ group_level }}</span></span> 
            and has accumulated <span class='badge badge-important'><span data-bind='text:averagePoints'>{{average_points}}</span> average points</span>.  
            In order to advance in level and unlock more activities the <strong>average number of points contributed by each member of your
            group</strong> must be equal to or greater than <span data-bind='text: pointsToNextLevel' class='badge badge-info'>{{points_to_next_level}}</span>.  In order to reach this target <span class='text-warning'>you and a
            majority of the members of your group</span> must perform high point activities when they are available.
            <table class='table table-bordered'>
                <thead><tr><th>Group</th><th>Level</th><th>Points needed to reach the next level</th><th>Average number of points</th><th>Total points</th></tr></thead>
                <tbody data-bind='foreach: groupData'>
                <tr>
                    <td data-bind='text: group'></td>
                    <td data-bind='text: groupLevel'></td>
                    <td data-bind='text: pointsToNextLevel'></td>
                    <td data-bind='text: averagePoints'></td>
                    <td data-bind='text: totalPoints'></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class='tab-pane' id='faq'>
            <h2>Frequently Asked Questions</h2>
            <div class='well'>
                <h4>Why do the activities performed in the previous day not count for today?</h4>
                <p>
                In order to advance in level and unlock more activities you must reach an average level of points in your
                group during one day, starting at 0.00AM.  Every day at midnight the server will check your group's average number of
                points and determine whether or not you should move on to the next level.
                If your group advances in level your group will once again start at 0 points with the additional unlocked
                activities for that level available to perform. If your group did not reach the next level, your group
                will start with 0 points at the same level with the same activities available as the previous day.
                </p>
            </div>
            <div class='well'>
                <h4>I don't have a car or anyone to carpool with, so how can I carpool?</h4>
                <p>
                You don't have to actually perform the activity in the real world to click on "perform this activity" -
                these are just virtual activities at the moment. In the future we plan to include options to gain points by
                actually performing these activities.
                </p>
            </div>
        </div>
        <div class='tab-pane' id='group-wall'>
            <h3>Chat messages</h3>
            <form id='chat-form' class='form-horizontal' data-bind='submit: submitChatMessage'>
                <input type='hidden' name='participant_group_id' value='{{participant_group_relationship.id}}'/>
                <div class='control-group'>
                    <label class='control-label' for='chatText'>Chat</label>
                    <div class='controls'>
                        <input type='text' id='chatText' name='message' placeholder='Send a message to your group' />
                    </div>
                </div>
                <div class='control-group'>
                    <div class='controls'><a class='btn' data-bind='click: submitChatMessage'>Send</a></div>
                </div>
            </form>

            <div id='chat-div' class='scrollable-messages'>
                <div data-bind='ifnot: hasChatMessages() '>
                    <div class='alert alert-warning'>
                        No chat messages have been posted yet.
                    </div>
                </div>
                <div data-bind='if: hasChatMessages()'>
                    <div data-bind='foreach: chatMessages'>
                        <div class='alert alert-message chat-message'>
                            <strong data-bind='text: participant_name'></strong>: <em><span data-bind='text: message'></span></em>
                            <b class='pull-right' ><span data-bind='text: date_created'></span> ago</b>
                        </div>
                    </div>
                </div>
            </div>
            <h3>Recent activity</h3>
            <div data-bind='foreach: groupActivity' class='scrollable-messages'>
                <div class='alert alert-info'>
                    <span data-bind='text: participant_name'></span> performed <span data-bind='text: display_name'></span>,
                    earning <span class='badge badge-success' data-bind='text:points'></span> green points.
                    <b class='pull-right'><span data-bind='text: date_created'></span> ago</b>

                </div>
            </div>
        </div>
    </div>
</div>
<div id='activityUnavailableModal' class='modal hide fade' tabindex='-1' role=dialog'
    aria-labelledby='activityUnavailableModalLabel'
    aria-hidden='true'>
    <div class='modal-header'>
        <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>x</button>
        <h3 id='activityUnavailableModalLabel'>Unable to perform activity</h3>
    </div>
    <div class='modal-body'>
        <div class='alert alert-error'>
        <span class='text-error' data-bind='text:errorMessage'></span>
        </div>
    </div>
    <div class='modal-footer'>
        <button class='btn' data-dismiss='modal' aria-hidden='true'>Continue</button>
    </div>
</div>
<div id='activityPerformedModal' class='modal hide fade' tabindex='-1' role='dialog'
    aria-labelledby='activityPerformedModalLabel'
    aria-hidden='true'>
    <div class='modal-header'>
        <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>x</button>
        <h3 id='activityPerformedModalLabel'>Successfully performed activity</h3>
    </div>
    <div class='modal-body'>
        <p>
        You have successfully performed <span class='text-success' data-bind='text:lastPerformedActivity'></span>,
        earning <span class='badge badge-success' data-bind='text: lastPerformedActivityPoints'></span> green points for
        your group.
        </p>
    </div>
    <div class='modal-footer'>
        <button class='btn' data-dismiss='modal' aria-hidden='true'>Continue</button>
    </div>
</div>
{% endblock page %}
{% block javascript %}
{{ block.super }}
<script type='text/javascript'>
$(function() {
    // FIXME: set up bootstrap nav-tabs to be semi-refresh friendly, remove in production
    var url = document.location.toString();
    if (url.match('#')) {
        $('.nav-tabs a[href=#'+url.split('#')[1]+']').tab('show');
    }
    $('.nav-tabs a').on('shown', function(evt) {
        window.location.hash = evt.target.hash;
    });
    function LighterFootprintsModel(modelJson) {
        var self = this;
        var model = ko.mapping.fromJS(modelJson);
        console.debug("model activities by level");
        console.debug(model.activitiesByLevel());
        // FIXME: hacky, figure out if there is a way to pass the observable in directly from the model object we get in
        // performActivity
        model.lastPerformedActivity = ko.observable();
        model.lastPerformedActivityPoints = ko.observable();
        model.errorMessage = ko.observable();
        model.hasChatMessages = function() {
            return model.chatMessages().length > 0;
        }
        model.submitChatMessage = function() {
            var formData = $('#chat-form').serialize();
            $.post('/lighterprints/api/message', formData, function(data) {
                ko.mapping.fromJS(data, model);
            });
            $('#chatText').val('');
            return false;
        }
        model.availableActivities = ko.computed(function() {
            console.log(model.activities());
            var availables = ko.utils.arrayFilter(model.activities(), function(activity) { return activity.available_now() });
            console.log(availables);
            return availables;
        });
        model.hasAvailableActivities = ko.computed(function() {
            return model.availableActivities().length > 0;
        });
        model.performActivity = function(activityModel) {
            if (! activityModel.available_now()) {
                console.debug("trying to perform unavailable activity");
                console.debug(activityModel);
                model.errorMessage("The activity " + activityModel.display_name() + " is not currently available.");
                $('#activityUnavailableModal').modal();
                return;
            }
            var activityId = activityModel.pk();
            var formData = $('#activityform' + activityId).serialize();
            $.post('/lighterprints/api/do-activity', formData, function(data) {
                console.log(data);
                if (data.success) {
                    ko.mapping.fromJSON(data.viewModel, model);
                    console.debug("successfully performed activity");
                    model.lastPerformedActivity(activityModel.display_name());
                    model.lastPerformedActivityPoints(activityModel.points());
                    $('#activityPerformedModal').modal();
                }
                else {
                    model.errorMessage("Unable to perform activity: " + data.message);
                    $('#activityUnavailableModal').modal();
                }
            });
        };
        return model;
    }
    // set up KO binding, using one master view model
    var viewModelData = $.parseJSON("{{ view_model_json|escapejs }}");
    console.log(viewModelData);
    var viewModel = new LighterFootprintsModel(viewModelData);
    console.log(viewModel);
    ko.applyBindings(viewModel);
});
</script>
{% endblock %}
