{% extends "participant/base.html" %}
{% block head %}
{{ block.super }}
<link rel='stylesheet' href='{{STATIC_URL}}/css/lighterprints/style.css'/>
<link rel="stylesheet" href="//fast.fonts.com/cssapi/e86344be-530a-495b-be28-7a22a9cda219.css"/>
{% endblock %}
{% block headerlinks %}
<ul class='nav nav-tabs' id='lfp-navtabs'>
    <li><a class='brand'><img alt='footprint logo' src='{{STATIC_URL}}/images/lighterprints/logo.png' width="25" height="25"> lighter<strong class='lighterprints-green'>footprints</strong></a></li>
    <li class='active'><a href='#dashboard' data-toggle='tab'><i class='icon-dashboard'></i> Dashboard</a></li>
    <li><a href='#challenges' data-toggle='tab'><i class='icon-star-empty'></i> Challenges</a></li>
    <li><a href='#team' data-toggle='tab'><i class='icon-comments-alt'></i> My Team</a></li>
    <li><a href='#help' data-toggle='tab'><i class='icon-question-sign'></i> Help</a></li>
</ul>
{% endblock %}
{% block logo %}
{% endblock %}
{% block content %}
<div class='tabbable'>
    <div class='tab-content'>
        <div class='tab-pane active' id='dashboard'>
            <h1 class='header'><i class='icon-dashboard'></i> Team Dashboard</h1>
            <!-- FIXME: re-enable this at some point
            <div data-bind='if: firstVisit()'>
            -->
            <div class='alert alert-block alert-white'>
                <button type="button" class="close" data-dismiss="alert"><i class='icon-remove-sign'></i></button>
                <h2 class='muted'>Welcome to Lighter Footprints, <i class='lighterprints-blue'><span data-bind='text: groupName'></span>!</i></h2>
                <p>
                    You have been randomly placed in a group of {{ participant_group_relationship.group.size }}
                    participants. In this experiment you can perform virtual actions that represent green alternatives
                    to some common daily activities.
                </p>
                <p>
                    <i class='lighterprints-green icon-leaf'></i> Earn <span class='badge badge-lighterprints-green'>green points</span> by
                    completing challenges.  Rank up by <b>increasing your team's average score.</b>.
                </p>
                <p>
                    <i class='icon-star text-gold'></i> Some challenges are unlocked all day, and others are only
                    unlocked at specific times.  Discover new challenges by ranking up!
                </p>
                <p>
                    <strong>Your point totals reset at midnight each night.</strong>  If your group's average score
                    isn't high enough to rank up, you must start over.
                </p>
            </div>
            <!-- FIXME: disabled conditional instruction message
            </div>
            -->
            <div class='row lighterprints-scoreboard'>
                <div class='span2'>
                    <h5><span class='lighterprints-scoreboard-uppercase'>Today's Score</span>
                        <i id='score-info' style='margin:8px 0 0 0;' rel='popover' data-trigger='hover' data-placement='top' data-content="This is your team's average score for the day.  Complete high-value challenges to rank your team up." class='pull-right icon-info-sign'></i></h5>
                    <table>
                        <tr>
                            <td class='lighterprints-scoreboard-xlarge'><span data-bind='text: averagePoints'></span></td>
                            <td><i class='lighterprints-green icon-leaf icon-2x'></i></td>
                        </tr>
                    </table>
                </div>
                <div class='span2 left-divider'>
                    <h5><span class='lighterprints-scoreboard-uppercase'>Current Level</span></h5>
                    <h1><img class='group-level' width="104" height="65" data-bind="attr: { src: '{{STATIC_URL}}/images/lighterprints/rank' + groupLevel() + '.png' }"></h1> <br>
                </div>
                <div class='span2 left-divider'>
                    <h5><span class='lighterprints-scoreboard-uppercase'>Today's Progress</span></h5>
                    <div class='lighterprints-scoreboard-xlarge'>
                        <span data-bind='text: averagePoints'></span> / <span data-bind='text:pointsToNextLevel'></span>
                    </div>
                </div>
                <div class='span2 left-divider'>
                    <h5><span class='lighterprints-scoreboard-uppercase'>Time Remaining</span></h5>
                    <div class='lighterprints-scoreboard-xlarge'><span data-bind='text:hoursLeft'></span>h <span data-bind='text:minutesLeft'></span>m</div>
                </div>
            </div>
            <h3 class='underline'>Challenges</h3>
            <div class='tabbable challenge-tabs'>
                <ul class='nav nav-tabs'>
                    <li class='active'><a href='#unlocked-challenges' data-toggle='tab'><span class='text-gold'><i class='icon-star'></i> Unlocked</span></a></li>
                    <li><a href='#locked-challenges' data-toggle='tab'><i class='icon-lock'></i> Locked</a></li>
                </ul>
                <div class='tab-content challenges'>
                    <div class='tab-pane active' id='unlocked-challenges'>
                        <div data-bind="template: { name: 'challenges-template', data: { challenges: unlockedChallenges() } }"></div>
                    </div>
                    <div class='tab-pane' id='locked-challenges'>
                        <div data-bind="template: { name: 'challenges-template', data: { challenges: lockedChallenges() } }"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class='tab-pane' id='challenges'>
            <h1 class='header'><i class='icon-star'></i> Challenges</h2>
            <div class='alert alert-block alert-white'>
                <button type="button" class="close" data-dismiss="alert"><i class='icon-remove-sign'></i></button>
                <h2>Complete challenges to earn green points.</h2>
                <p>
                Challenges are divided up into 3 levels.  In order to unlock the next level's challenges your group must earn
                enough points so that the <strong>average number of points</strong> per participant is greater than
                <span data-bind='text:pointsToNextLevel' class='badge badge-lighterprints-green'></span>.
                </p>
                <p>
                <i class='icon-time'></i> Some challenges are available all day, and others are only available at <strong>certain hours</strong>.
                </p>
            </div>
            <div data-bind='foreach: activitiesByLevel'>
                <h3 class='underline'>Level <span data-bind='text: $index() + 1'></span></h3>
                <div style='margin-top: -10px;' class='challenges' data-bind='template: { name: "challenges-template", data: { challenges: $data } }'></div>
            </div>
        </div>
        <div class='tab-pane' id='help'>
            <h1 class='header'><i class='icon-question-sign'></i> Instructions</h1>
            <p>
            You have been randomly placed in a group of <strong>{{ participant_group_relationship.group.size }} participants</strong>.
            In this experiment you can perform virtual actions that represent green alternatives to some common daily
            activities.  Some of these activities are available all day, and others are only available at
            specific times.  You can learn more about them by clicking on the <a href='#challenges' data-bind='click: activateChallengesTab'>Challenges tab</a> and selecting an activity.
            </p>
            <h4>Challenges, Green Points, and Levels</h4>
            <p>
            Each <strong class='text-gold'>challenge</strong> is worth a certain number of 
            <strong class='lighterprints-green'>green points <i class='icon-leaf'></i></strong>.
            For example, <em>Eat locally grown food for lunch</em> (available from 12-2pm) is worth 
            <span class='lighterprints-green'>15 <i class='icon-leaf'></i></span> green points.
            In order to perform this challenge you must login to the application between 12pm and 2pm, 
            select the challenge from the list below, and click the &quot;Perform&quot; button.
            </p>
            <p>
            Your group is currently <strong class='text-gold'>Level <span data-bind='text:groupLevel'></span></strong> and has an average score of 
            <strong class='lighterprints-green'><span data-bind='text:averagePoints'></span> <i class='icon-leaf'></i></strong>.  In order to
            advance in level and unlock more challenges the <em>average number of points contributed by each member of your group</em> must be equal to or greater than 
            <strong class='lighterprints-green'><span data-bind='text: pointsToNextLevel'></span> <i class='icon-leaf'></i></strong>.
            In order to reach this target you and a majority of the members of your group must perform
            high point challenges when they are available.
            </p>
            <h4>How to participate</h4>
            <p>
            To participate, simply click on the <a href='#challenges' data-bind='click: activateChallengesTab'>Challenges tab</a>, and select a challenge you'd like to perform.
            You can also leave messages for your other teammates in the 
            <a href='#team' data-bind='click: activateTeamTab'>My Team tab</a> or visit the 
            <a href='#dashboard' data-bind='click:activateDashboardTab'>Dashboard</a> to view your team's progress.
            </p>
            <h3 class='underline'>Frequently Asked Questions</h3>
            <div class='well alert-white'>
                <h4>Why do the challenges performed in the previous day not count for today?</h4>
                <p>
                In order to advance in level and unlock more challenges you must reach an average level of points in your
                group during one day, starting at 0.00AM.  Every day at midnight the server will check your group's average number of
                points and determine whether or not you should move on to the next level.
                If your group advances in level your group will once again start at 0 points with the additional unlocked
                challenges for that level available to perform. If your group did not reach the next level, your group
                will start with 0 points at the same level with the same challenges available as the previous day.
                </p>
            </div>
            <div class='well alert-white'>
                <h4>I don't have a car or anyone to carpool with, so how can I carpool?</h4>
                <p>
                You don't have to actually perform the activity in the real world to click on "perform". These are just
                virtual challenges for the time being. In the future we plan to allow participants to gain points by
                actually performing these challenges.
                </p>
            </div>
        </div>
        <div class='tab-pane' id='team'>
            <h1 class='header'><i class='icon-comment'></i> My Team</h1>
            <h3 class='underline'>Team Chat</h3>
            <form class='form-inline' id='chat-form' data-bind='submit: submitChatMessage'>
                <div style='width: 90%;' class='input-prepend'>
                    <span class='add-on'><i class='icon-comment'></i></span>
                    <input style='width: 90%;' type='text' id='chatText' name='message' placeholder='Send a message to your group' />
                </div>
                <button class='btn btn-lighterprints-blue' data-bind='click: submitChatMessage'>Send</button>
                <input type='hidden' name='participant_group_id' value='{{participant_group_relationship.id}}'/>
            </form>
            <div id='chat-div' class='scrollable-messages'>
                <div data-bind='ifnot: hasChatMessages() '>
                    <div class='alert alert-warning'>
                        No chat messages have been posted yet.
                    </div>
                </div>
                <div data-bind='if: hasChatMessages()'>
                    <div data-bind='foreach: chatMessages'>
                        <div class='alert alert-message chat-message'>
                            <strong data-bind='text: participant_name'></strong>: <em><span data-bind='text: message'></span></em>
                            <b class='pull-right' ><span data-bind='text: date_created'></span> ago</b>
                        </div>
                    </div>
                </div>
            </div>
            <h3 class='underline'>Team activity</h3>
            <table class='table'>
                <tbody data-bind='template: { name: groupActivityTemplate, foreach: teamActivity() }'>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div id='activityUnavailableModal' class='modal hide fade' tabindex='-1' role='dialog'
    aria-labelledby='activityUnavailableModalLabel'
    aria-hidden='true'>
    <div class='modal-header'>
        <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>x</button>
        <h3 id='activityUnavailableModalLabel'>Unable to perform activity</h3>
    </div>
    <div class='modal-body'>
        <div class='alert alert-error'>
            <span class='text-error' data-bind='text:errorMessage'></span>
        </div>
    </div>
    <div class='modal-footer'>
        <button class='btn btn-primary' data-dismiss='modal' aria-hidden='true'>Continue</button>
    </div>
</div>
<div id='activityPerformedModal' class='modal hide fade' tabindex='-1' role='dialog'
    aria-labelledby='activityPerformedModalLabel'
    aria-hidden='true'>
    <div class='modal-header'>
        <h3 id='activityPerformedModalLabel'>Challenge Completed</h3>
    </div>
    <div class='modal-body'>
        <div class="progress progress-striped active">
            <div class="bar" style="width: 100%;"></div>
        </div>
        <div id='activityPerformedModalText' data-bind='with: lastPerformedActivity' class='hide'>
            <div class='row-fluid pagination-centered'>
                <img data-bind='attr: {src: "{{STATIC_URL}}/images/lighterprints/badges/" + name() + ".png" }'>
            </div>
            <h3>You completed a challenge!</h3>
            <p>
                <strong><em data-bind='text: display_name'></em></strong> for <span class='lighterprints-green' data-bind='text: points'></span><i class='icon-leaf lighterprints-green'></i>
            </p>
            <p data-bind='text: summary'></p>
        </div>
    </div>
    <div class='modal-footer'>
        <button class='btn disabled' data-dismiss='modal' aria-hidden='true'>Continue</button>
    </div>
</div>
{% endblock content %}
{% block sidebar %}
<div class='lighterprints-sidebar'>
<h3 class='lighterprints-sidebar-header'><i class='text-gold icon-trophy'></i> Leaderboard</h3>
<ul class='nav nav-list' data-bind='foreach: groupData'>
    <li><strong>#<span data-bind='text:$index() + 1'></span></strong> <span data-bind='css: { "bold lighterprints-blue": groupName() == $root.groupName()}'><span data-bind='text: groupName'></span></span><span class='pull-right badge badge-lighterprints-green' data-bind='text: averagePoints'></span></li> 
    <li class='divider'></li>
</ul>
<h3 class='lighterprints-sidebar-header'><i class='lighterprints-blue icon-group'></i> Team Activity <span class='pull-right'><small><a href='#team' data-bind='click: activateTeamTab' data-toggle='tab'>View all</a></small></span></h3>
<table class='table'>
    <tbody data-bind='template: { name: groupActivityTemplate, foreach: groupActivity.slice(0, 6) }'>
    </tbody>
</table>
</div>
{% endblock sidebar %}
{% block footerlinks %}
<ul class='nav-footer'>
    <li><a href='#dashboard' data-bind='click: activateDashboardTab' data-toggle='tab'>Dashboard</a></li>
    <li><a href='#challenges' data-bind='click: activateChallengesTab' data-toggle='tab'>Challenges</a></li>
    <li><a href='#team' data-bind='click: activateTeamTab' data-toggle='tab'>My Team</a></li>
    <li><a href='#help' data-bind='click: activateHelpTab' data-toggle='tab'>Help</a></li>
    <li class='pull-right'><a>&copy; {% now "Y" %} Arizona Board of Regents</a></li>
</ul>
{% endblock footerlinks %}
{% block footerlogo %}
<div class='footer-logo'><img alt='footprint logo' src='{{STATIC_URL}}/images/lighterprints/logo.png' width="25" height="25"> <span style='font-size: 1.5em;'>lighter<strong>footprints</strong></span></div>
{% endblock footerlogo %}
{% block javascript %}
{{ block.super }}
<script src="//fast.fonts.com/jsapi/e86344be-530a-495b-be28-7a22a9cda219.js"></script>
<script src='{{STATIC_URL}}js/lighterprints/model.js'></script>
<script>
function postComment(submitButton) {
    var parentForm = $(submitButton).closest('form')[0];
    // var parentForm = submitButton.form;
    // FIXME: so terribly dirty, need to figure out a way to utilize KO binding to get rid of this ugliness
    var popoverTarget = $(parentForm).parent().parent().parent().find('.comment-popover');
    console.debug(popoverTarget);
    var targetId = $(popoverTarget).attr("data-target-id");
    console.debug("target action id: " + targetActionId);
    var targetIdInput = $(parentForm).find(':input[name="target_id"]');
    targetIdInput.val(targetId);
    var formData = $(parentForm).serialize();
    $.post('/lighterprints/api/comment', formData, function(response) {
        if (response.success) {
            var viewModel = response.viewModel;
        }
    });
    // send the data to the comment api
    return false;
}
function dismissCommentPopover() {
    $('.comment-popover').popover('hide');
}
$(function() {
    // XXX: set up bootstrap nav-tabs to be semi-refresh friendly, remove in production
    /*
    var url = document.location.toString();
    if (url.match('#')) {
        $('.nav-tabs a[href=#'+url.split('#')[1]+']').tab('show');
    }
    $('.nav-tabs a').on('shown', function(evt) {
        window.location.hash = evt.target.hash;
    });
    */
    function activateTabFunctor(tabHref) {
        return function() {
            $('#lfp-navtabs a[href="' + tabHref + '"]').tab('show');
        }
    }
    // set up KO binding, using one master view model
    var viewModelData = $.parseJSON("{{ view_model_json|escapejs }}");
    var viewModel = new LighterFootprintsModel(viewModelData);
    // custom view model methods, some of these may be lifted into the model itself
    viewModel.groupActivityTemplate = function(groupActivity) {
        return groupActivity.parameter_name();
    };
    viewModel.teamActivity = ko.computed(function() {
        return ko.utils.arrayFilter(viewModel.groupActivity(), function(groupActivity) {
            return groupActivity.parameter_name().indexOf("chat_message") != 0;
        });
    });
    viewModel.activateChallengesTab = activateTabFunctor('#challenges');
    viewModel.activateDashboardTab = activateTabFunctor('#dashboard');
    viewModel.activateHelpTab = activateTabFunctor('#help');
    viewModel.activateTeamTab = activateTabFunctor('#team');
    viewModel.postComment = function(targetModel) {
        var formData = $('#commentForm' + targetModel.pk()).serialize();
        $.post('/lighterprints/api/comment', formData, function(response) {
            if (response.success) {
                ko.mapping.fromJSON(response.viewModel, viewModel);
            }
        });
    };
    viewModel.like = function(targetModel) {
        // FIXME: if targetModel.likes already contains this participant's pgr.pk, don't allow for this again
        if (targetModel.liked()) {
            console.debug("this is already liked");
            return;
        }
        targetModel.liked(true);
        $.post('/lighterprints/api/like', 
            {participant_group_id: {{ participant_group_relationship.pk }}, target_id: targetModel.pk()},
            function(data) {
                targetModel.liked(data.success);
            });
    };
    viewModel.perform = function(challengeModel) {
        if (! challengeModel.availableNow()) {
            // FIXME: modal is slow, no feedback on this for now
            // model.errorMessage("The activity " + activityModel.display_name() + " is not currently available.");
            // $('#activityUnavailableModal').modal();
            return;
        }
        // FIXME: manually manipulating DOM elements via JQuery feels dirty when mixed in with KO's data binding
        $('#activityPerformedModal .progress').removeClass('hide');
        $('#activityPerformedModalText').addClass('hide');
        $('#activityPerformedModal .btn').addClass('disabled');
        $('#activityPerformedModal').modal();
        var id = challengeModel.pk();
        var formData = $('#challengeForm' + id).serialize();
        $.post('/lighterprints/api/do-activity', formData, function(data) {
                if (data.success) {
                    ko.mapping.fromJSON(data.viewModel, viewModel);
                    viewModel.lastPerformedActivity(challengeModel);
                    // FIXME: find a better way to handle this?
                    $('#activityPerformedModal .progress').addClass('hide');
                    $('#activityPerformedModalText').removeClass('hide');
                    $('#activityPerformedModal .btn').removeClass('disabled');
                }
                else {
                    console.debug("ERROR: " + data.message);
                    viewModel.errorMessage("Unable to perform activity: " + data.message);
                    $('#activityUnavailableModal').modal();
                }
            });
    };
    ko.applyBindings(viewModel);
    // FIXME: use $('.popover').popover() if we end up having a lot more of these.
    $('#score-info').popover();
});
</script>
<!-- bootstrap popover templates -->
<script type='text/html' id='commentPopoverForm'>
<form data-bind='attr: { id: "commentForm" + pk() }'>
<textarea name='comment' rows='3'></textarea>
<input type='hidden' name='participant_group_id' value='{{participant_group_relationship.pk}}' />
<input type='hidden' name='target_id' data-bind='value: pk()' />
<a class='btn btn-lighterprints-blue' data-bind='click: $root.postComment'>POST</button> <a style='position: relative; left: 8px; top: 5px;' href='javascript:void(0)' class='lighterprints-gray' data-bind='click: $root.closeCommentPopover' >Cancel</a>
</form>
</script>
<!-- knockout templates -->
<script type='text/html' id='likeCommentTemplate'>
<a class='comment comment-popover' href='javascript:void(0)' rel="popover" data-placement='left' data-bind='popover: { content: "#commentPopoverForm", id: pk()}'>
<i class='comment lighterprints-gray icon-comment'></i>
</a>
<span data-bind='ifnot: liked'>
<a href='#' data-bind='click: $root.like'>
<i class='like lighterprints-gray icon-heart'></i>
</a>
</span>
<span data-bind='if: liked'>
<i class='liked icon-heart'></i>
</span>
</script>
<script type='text/html' id='comment'>
    <tr>
        <td style='vertical-align: top'><i class='icon-heart lighterprints-red'></i></td>
        <td>
            <strong data-bind='text: participant_name'></strong>
            <small class='pull-right muted'><span data-bind='text: date_created'></span></small>
            <div>commented on your <span data-bind='text: target_action'></span>:
            <small><i class='icon-quote-left'></i></small>
            <span data-bind='text:message'></span>
            <small><i class='icon-quote-right'></i></small>
            </div>
            <div data-bind='template: "likeCommentTemplate"'></div>
        </td>
    </tr>
</script>
<script type='text/html' id='like'>
    <tr>
        <td style='vertical-align: top'><i class='icon-heart lighterprints-red'></i></td>
        <td>
            <strong data-bind='text: participant_name'></strong>
            <small class='pull-right muted'><span data-bind='text: date_created'></span></small>
            <div>
            <small>
            liked your 
            <span data-bind='if: target.parameter_name() === "activity_performed"'>
            completed challenge, <em data-bind='text: target.value'></em>
            </span>
            <span data-bind='if: target.parameter_name() === "chat_message"'>
            message, &quot;<em data-bind='text: target.value'></em>&quot;
            </span>
            </small>
            </div>
        </td>
    </tr>
</script>
<script type='text/html' id='chat_message'>
    <tr>
        <td style='vertical-align: top'><i class='icon-comment lighterprints-blue'></i></td>
        <td>
            <strong data-bind='text: participant_name'></strong>
            <small class='pull-right muted'><span data-bind='text: date_created'></span></small>
            <div>
            <small><i class='icon-quote-left'></i></small>
            <span data-bind='text:message'></span>
            <small><i class='icon-quote-right'></i></small>
            </div>
            <div data-bind="template: 'likeCommentTemplate'"></div>
        </td>
    </tr>
</script>
<script type='text/html' id='activity_performed'>
    <tr>
        <td style='vertical-align: top'><i class='icon-star text-gold'></i></td>
        <td>
            <strong data-bind='text: participant_name'></strong>
            <small class='pull-right muted'><span data-bind='text: date_created'></span></small>
            <div>earned <span class='lighterprints-green' data-bind='text:points'></span><i class='icon-leaf lighterprints-green'></i>
                for <span data-bind='text: $root.groupName'></span> by completing <em><span data-bind='text: display_name'></span></em>.
            </div>
            <div data-bind="template: 'likeCommentTemplate'"></div>
        </td>
    </tr>
</script>
<script type='text/html' id='challenges-template'>
<div data-bind='foreach: challenges'>
<div class='row challenge-row'>
    <div class='span2'>
        <img style='padding: 10px 0 0 20px;' data-bind='attr: {src: "{{STATIC_URL}}/images/lighterprints/badges/" + name() + ".png" }'>
    </div>
    <div class='span4'>
        <h4 data-bind='css: status, text:display_name'></h4>
        <p>
        <span data-bind='css: status, text:summary'></span>
        </p>
        <form data-bind='attr: { id: "challengeForm" + pk() }' class='form-horizontal' method='post'>
            <input data-bind='value: pk' type='hidden' name='activity_id' />
            <input type='hidden' name='participant_group_id' value='{{participant_group_relationship.pk}}' />
            <a data-bind='css: status, click: $root.perform' class='btn'>
            <span data-bind='if: availableNow'>Perform</span>
            <span data-bind='if: completed'>Completed <i class='icon-check'></i></span>
            <span data-bind='if: expired'>Expired <i class='icon-warning-sign'></i></span>
            <span data-bind='if: upcoming'>Not yet available <i class='icon-time'></i></span>
            <span data-bind='if: locked'>Locked <i class='icon-lock'></i></span>
            </a> <small><a href='#'>Learn more</a></small>
        </form>
    </div>
    <div style='padding: 15px 0;' class='span2'>
        <table>
        <tr><td><span class='lighterprints-scoreboard-large' data-bind='text:points'></td><td style='text-align: center;'><i class='icon-leaf lighterprints-green'></i></td></tr>
        </table>
        <div data-bind='css: status'><i class='icon-time'></i> <strong><span data-bind='text: time_slots'></span></strong></div>
    </div>
</div>
</div>
</script>
{% endblock %}
