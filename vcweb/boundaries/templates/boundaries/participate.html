{% extends "participant/base.html" %}
{% load static %}
{% block head %}
{{ block.super }}
<link rel='stylesheet' href='{% static "css/boundaries/style.css" %}'/>
{% endblock %}
{% block content %}
<div data-bind='template: { name: templateId(), afterRender: afterRenderTemplate }'>
</div>
<div id='progress-modal' class='modal hide fade'>
    <div class='model-header'>
        <h3>Updating experiment data</h3>
    </div>
    <div class='modal-body'>
        <div class='progress progress-striped active'>
            <div id='progress-bar' class='bar' style='width: 100%'></div>
        </div>
    </div>
</div>
{% endblock content %}
{% block sidebar %}
<div data-bind='ifnot: isInstructionsRound'>
<h3>Chat</h3>
<div data-bind='ifnot: chatEnabled'>
    <div class='alert alert-error'>
        <i class='icon-warning-sign'></i> Chat is currently disabled.
    </div>
</div>
<form id="chat-form" class='form-inline'>
    <div class='input-prepend input-append'>
        <span class='add-on'><i class='text-info icon-comment'></i></span>
        <input id='chatMessage' type="text" placeholder="Enter a chat message">
        <button class='btn btn-primary' data-bind='click: submitChatMessage'>Send</button>
    </div>
</form>
<div class='chat-sidebar'>
    <div id='chat-div'>
        <div class='chat-messages' data-bind='foreach: chatMessages'>
            <i class='icon-user muted'></i> <strong>Participant <span data-bind='text: participant_number'></strong><b class='pull-right muted' data-bind='text: date_created'></b>
            <p>
            <small><i class='icon-double-angle-right'></i></small> <span data-bind='text: message'></span>
            </p>
        </div>
    </div>
</div>
</div>
{% endblock sidebar %}
{% block javascript %}
{{ block.super }}
<!-- ko templates -->
<script type='text/html' id='PRACTICE_ROUND_RESULTS'>
    <h3>Practice Round Results</h3>
    <p>
    You harvested <span class='badge badge-success' data-bind='text: storage'></span> trees.
    If this had been been a paid session, you would have earned <strong class='text-success' data-bind='text: totalEarnings'></strong>.
    </p>
    <p>
    We will now move on to the <strong>paid rounds.</strong>
    </p>
    <ul class='pager'>
        <li class='next'>
        <a href='javascript: void()' data-bind='click: activateTemplate.bind($data, "PAID_EXPERIMENT_INSTRUCTIONS")'>Ok, continue</a>
        </li>
    </ul>
</script>
<script type='text/html' id='PAID_EXPERIMENT_INSTRUCTIONS'>
    <h2>Paid Experiment Instructions</h2>
    <h3>Two Sessions</h3>
    <p>
    This experiment is composed of two different, unconnected sessions.  Your group will be randomly selected for each
    session, so you will be playing with a different group each time.  We will pay you for one of these two sessions,
    chosen at random.  You have exactly 50% chance of being paid for your earnings in each session.
    </p>
    <h3>Group and Individual Status</h3>
    <p>
    You will be able to observe the status of the members of your group each round.  Likewise group members will see
    your status, and those of the group.
    </p>
    <h3>Group Chat</h3>
    <p>
    You will be able to text chat with the other members of your group.  Once you have made a harvest decision, you will
    no longer be able to contribute to the chat for that round.
    </p>
    <h3>Harvest Choice</h3>
    <p>
    You will have a maximum of <i class='icon-clock'></i><span data-bind='text: roundDuration'></span> seconds to make a
    harvest decision each round.  A countdown will alert you when there are 
    <span data-bind='text: warningCountdownTime'></span> seconds remaining to make a harvest choice.  When the countdown
    reaches zero, any value you have selected will be submitted.  <strong>The default harvest is zero.</strong>
    </p>

    <ul class='pager'>
        <li class='previous'>
        <a href='javascript: void()' data-bind='click: activateTemplate.bind($data, "PRACTICE_ROUND_RESULTS")'>Back</a>
        </li>
        <li class='next'>
        <a href='javascript: void()' data-bind='click: participantReady'>Ok, I understand</a>
        </li>
    </ul>
</script>
<script type='text/html' id='TREATMENT_A_INSTRUCTIONS'>
<h3>Session <span data-bind='text: sessionId'></span> Instructions</h3>
<p>
In this session, there are two groups or villages.  Each group has a forest that the other group cannot harvest.  Both
forests have the same growth capacity.  In addition, you may observe the other group, their storage amounts, and their
forest status.  Similarly, they may observe your group in the same way.
</p>
<h3>Key points</h3>
<ul>
    <li>Two groups</li>
    <li>Each group has an <b>exclusive</b> forest of the same size</li>
    <li>You may observe the other group</li>
    <li>They may observe your group</li>
</ul>
<ul class='pager'>
    <li class='next'>
    <a href='javascript: void()' data-bind='click: participantReady'>Ok, I am ready to start</a>
    </li>
</ul>
</script>
<script type='text/html' id='WAITING_ROOM'>
<h3>Waiting for other participants</h3>
<div>
Please wait.  The experiment will continue shortly once all the participants are ready.
<p>
<span class='badge'
data-bind='css: { "badge-important": readyParticipants() < (totalNumberOfParticipants() / 2), "badge-success": readyParticipants() > (totalNumberOfParticipants() / 2)}, text: readyParticipants'></span> of <span class='badge badge-success' data-bind='text: totalNumberOfParticipants'></span> participants are ready.
</p>
</div>
</div>
<div class='progress progress-success progress-striped active'>
<div class='bar' data-bind='style: { width: readyParticipantsPercentage() + "%" }'></div>
</div>
</script>
<script type='text/html' id='WELCOME'>
<h3>Welcome</h3>
<p class='lead'>
    The experiment will begin shortly after everyone has been assigned a station and has had time to log in.
</p>
<div class='well'>
    <div class='alert alert-info'>
    <i class='text-success icon-info-sign'></i> Please <strong>wait quietly and do not close this window, open any other applications, or communicate with any of
    the other participants</strong>.
    </div>
    <div class='alert alert-info'>
    <i class='text-success icon-info-sign'></i>
    Please also make sure to turn off, silence, and disable vibration alerts on your cell phones and any mobile devices before the experiment begins.
    </div>
    <div>
    Thank you for your cooperation.
    </div>
</div>
</script>
<script type='text/html' id='GENERAL_INSTRUCTIONS'>
<div id='instructions1'>
<h4>Harvesting and Profit</h4>
<p>
In this experiment you will harvest trees <i class='icon-leaf text-success'></i> to make a
profit and survive.  Each round you may choose to harvest between <strong>0</strong> and <strong data-bind='text: maxHarvestDecision'></strong> trees.  
Each tree you harvest will be exchanged for one token, and extra tokens will be kept in your <strong>savings</strong>
each round.
</p>
<h4>Cost of living</h4>
<p>
Each round you must pay living expenses of <span class='badge badge-important' data-bind='text: costOfLiving'></span>
tokens.  If, at any point you do not have enough tokens to pay the living expenses, you will not be paid or be able to
continue harvesting for the rest of the experimental session.  You will need to wait until the session is complete
before joining again.
</p>
<h4>Cash payment</h4>
<p>
If you collect enough tokens to pay living expenses until the end of the session you will be paid in cash 
<strong data-bind='text: formatCurrency(exchangeRate())'></strong> for each token you have.  It is possible that you
could earn as much as <strong data-bind='text: formatCurrency(maxEarnings())'></strong> for the entire experiment.
However, the final outcome depends on your choices and those of your group members.
</p>
<ul class='pager'>
<li class='next'>
<a href='javascript: void();' data-bind='click: activateTemplate.bind($data, "GENERAL_INSTRUCTIONS2")'>OK, I understand</a>
</li>
</ul>
</div>
</script>
<script type='text/html' id='GENERAL_INSTRUCTIONS2'>
<div id='instructions2'>
<h4>Forest Growth</h4>
<p>
Trees in the forest regrow much as real trees do.  The more trees there are, the faster empty places fill up with new
trees.  It is possible to destroy the forest by overharvesting.  If the forest is destroyed there will be no more trees
to harvest for the rest of the experiment.
</p>
<h4>Carrying Capacity</h4>
<p>
Initially there are <span class='badge badge-success' data-bind='text: initialResourceLevel'></span> trees in the
forest.  The forest grows new trees after every harvesting round, but the rate of growth depends on how large the forest
is.  The forest cannot grow at all with zero trees, or at its full size of <span data-bind='text:initialResourceLevel'></span> trees.  
Instead, it grows fastest at one half of full size; <span data-bind='text: initialResourceLevel() / 2'></span> trees.
At a size of <span data-bind='text: initialResourceLevel() / 2'></span> trees, the forest will produce <span
data-bind='text: initialResourceLevel() / 10'></span> trees each season.
</p>
<h4>Sustainable Harvesting</h4>
<p>
The highest amount of harvesting that the forest can permanently support is 24 trees per season.  If that number is
split between the 4 participants in your group, the forest has a capacity to produce 6 trees per individual per round.
</p>
<ul class='pager'>
<li class='previous'>
<a href='javascript: void();' data-bind='click: activateTemplate.bind($data, "GENERAL_INSTRUCTIONS")' >Back</a>
</li>
<li class='next'>
<a href='javascript: void();' data-bind='click: activateTemplate.bind($data, "GENERAL_INSTRUCTIONS3")' >OK, I understand</a>
</li>
</ul>
</div>
</script>
<script type='text/html' id='GENERAL_INSTRUCTIONS3'>
<div id='instructions3'>
<h4>Groups and Rounds</h4>
<p>
You have been randomly assigned to a group of size <strong data-bind='text:participantsPerGroup'></strong>.
In this experiment you will be sharing a virtual forest with the <span data-bind='text: participantsPerGroup() - 1'></span> 
other members in your group.  All participants in the experiment are in identical conditions and must harvest
trees to pay the cost of living <span data-bind='text: costOfLiving'></span> and make a profit.
</p>
<p>
We will now begin with some <strong>practice rounds</strong>.  These rounds will <strong>not</strong> contribute to your
earnings.  If you have any questions please raise your hand and someone will come to address your question.  Otherwise,
please click the button to continue.
</p>
<ul class='pager'>
<li class='previous'>
<a href='javascript: void();' data-bind='click: activateTemplate.bind($data, "GENERAL_INSTRUCTIONS2")' >Back</a>
</li>
<li class='next'>
<a href='javascript: void();' data-bind='click: activateTemplate.bind($data, "PRACTICE_ROUND_INSTRUCTIONS")'>OK, Continue to practice rounds</a>
</li>
</ul>
</div>
</script>
<script type='text/html' id='PRACTICE_ROUND_INSTRUCTIONS'>
<h3>No Payment</h3>
<p>
There will be no payment for this practice session.
</p>
<h3>Group and Individual Status</h3>
<p>
You will be able to observe the status of the members of your group each round.  Likewise, group members will see your
status, and those of your group.
</p>
<h3>Harvest Choice</h3>
<p>
Each round you will have a maximum of 1 minute to make a harvest decision.  THere are two ways to submit a harvest
decision:
</p>
<ol>
<li>Select a harvest amount and click submit</li>
<li>Select a harvest amount and wait for the end of the session</li>
</ol>
<p>
At the end of each round a countdown will alert you when there are 10 seconds remaining to make a harvest choice.  When
the countdown reaches zero, any value you have selected will be auto-submitted.  The default harvest is zero.
</p>
<ul class='pager'>
<li class='previous'>
<a href='javascript:void();' data-bind='click: activateTemplate.bind($data, "GENERAL_INSTRUCTIONS3")'>Back</a>
</li>
<li class='next'>
<a href='javascript: void();' data-bind='click: participantReady'>I have fully read and understand these instructions</a>
</li>
</ul>
</script>
<script type='text/html' id='REGULAR'>
<div class='row'>
    <div class='span5'>
        <h3>My Status</h3>
        <div class='row'>
            <div class='alert boundaries-status-dashboard span2'>
                <h4>Last harvest <i class='icon-info-sign' data-content="The number of trees you harvested last round."></i> </h4>
                <p>
                <strong class='text-success'><span data-bind='text:lastHarvestDecision'></span> <i class='icon-leaf'></i></strong>
                </p>
            </div>
            <div class='alert boundaries-status-dashboard span1'>
                <h4>Storage <i class='icon-info-sign' data-bind='attr: {"data-content": "You need at least " + costOfLiving() + " trees to survive each round."}'></i> </h4>
                <p>
                <strong data-bind='css: { "text-error": storage() < costOfLiving(), "text-success": storage() > costOfLiving()}'><span data-bind='text: storage'></span> <i class='icon-leaf'></i></strong>
                </p>
            </div>
            <div class='alert boundaries-status-dashboard span1'>
                <h4><i class='icon-time'></i> Time</h4>
                <p>
                <strong data-bind='css: { "text-error": secondsLeft() < warningCountdownTime(), "text-info": secondsLeft() > warningCountdownTime()}'>
                    <span data-bind='text: secondsLeft'></span> s
                </strong>
                </p>
            </div>
        </div>
    </div>
    <div class='span4'>
        <h3>Group Status</h3>
        <table class='table table-bordered table-condensed'>
            <thead>
                <tr><th>Player</th>
                    <!-- ko foreach: playerData -->
                    <th data-bind='text: id'></th>
                    <!-- /ko -->
                </tr>
            </thead>
            <tbody>
            <tr>
                <td>Last harvest</td>
                <!-- ko foreach: playerData -->
                <td data-bind='text: lastHarvestDecision'></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>Storage</td>
                <!-- ko foreach: playerData -->
                <td data-bind='text: storage'></td>
                <!-- /ko -->
            </tr>
            </tbody>
        </table>
    </div>
</div>
<h3>Forest</h3>
<div data-bind='if: isPracticeRound'>
    <div class='alert alert-error alert-block'>
        <h4>PRACTICE ROUND</h4>
        This is a practice round.  The decisions you make in this round will <b>NOT</b> contribute to your earnings.
    </div>
</div>

<div data-bind="ifnot: isResourceEmpty" id='resourceDisplay'>
    <div class='alert alert-info'>There are <strong class='badge badge-success' data-bind='text:resourceLevel'></strong> trees remaining in the forest.</div>
    <div data-bind='style: { width: resourceImageWidth, height: resourceImageHeight, background: resourceImageBackgroundUrl }'>
        &nbsp;
    </div>
</div>
<div data-bind="if: isResourceEmpty">
    <div style='padding: 8px; margin: auto; border: solid 1px; background: url("{{STATIC_URL}}images/forestry/deforestation.jpg") no-repeat center; height: 282px; width:425px;'>
        &nbsp;
    </div>
    <div class='alert alert-error'>There are no more trees to harvest. Please wait until the next round begins.</div>
</div>
<div data-bind='if: submitted'>
    <div class='alert alert-error'>
        You have submitted a harvest decision for <span class='badge badge-success' data-bind='text: harvestDecision'></span> trees.
    </div>
</div>

<div data-bind='if: canObserveOtherGroup'>
    <h3>Observe Other Group</h3>
    <div class='row'>
        <div class='span4'>
            <table>
                <tr>
                    <td><button class='btn' data-bind='click: showOtherGroup'><i class='icon-eye-open'></i> Observe</a></td>
                    <td><img src='{{STATIC_URL}}/images/boundaries/observe.png' alt='observe'></td>
                </tr>
            </table>
        </div>
        <div class='span5'>
            <div data-bind='if: shouldShowOtherGroup'>
                <table class='table table-bordered table-condensed'>
                    <caption>Observation Results</caption>
                    <thead>
                        <tr><th></th><th>Other Group</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>trees in forest</td><td data-bind='text:otherGroupResourceLevel()'></td></tr>
                        <tr><td>average harvest</td><td data-bind='text:otherGroupAverageHarvest().toFixed(1)'></td></tr>
                        <tr><td>average storage</td><td data-bind='text:otherGroupAverageStorage().toFixed(1)'></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<h3>Harvest</h3>
<div data-bind='ifnot: isResourceEmpty'>
    <form id='vcweb-form' action='' method='post' class='form-horizontal' >
        {% csrf_token %}
        <div class='control-group'>
        <div class='input-prepend'>
            <span class='add-on'><i class='icon-leaf'></i></span>
            <input id='participantGroupId' type='hidden' name='participant_group_id' data-bind='value: participantGroupId'/>
            <input id='harvestDecisionTextInput' type='hidden' name='integer_decision' data-bind='value: harvestDecision'>
            <select id='harvestDecisionSelect' required="required" form="vcweb-form" data-bind='value: harvestDecision'>
                <!-- ko foreach: ko.utils.range(0, maxHarvestDecision()) -->
                <option data-bind='value: $data, text: $data'></option>
                <!-- /ko -->
            </select>

        </div>
        <button id='submitDecision' data-bind='click: submitDecision' type='submit' class='btn btn-primary'>Submit</button>
        </div>
    </form>
</div>
</script>
<script type="text/javascript">
    $(function() {
        function ExperimentModel(experimentModelJson) {
            var self = this;
            var model = ko.mapping.fromJS(experimentModelJson);
            model.secondsLeft = ko.observable(0);
            model.currentInterval = ko.observable();
            model.totalEarnings = ko.computed(function() {
                return formatCurrency(model.storage() * model.exchangeRate());
            });
            model.templateId = ko.computed(function() {
                switch ( model.templateName() ) {
                    case 'PRACTICE':
                        return 'REGULAR';
                    default:
                        return model.templateName();
                }
            });
            model.setCurrentInterval = function(intervalId) {
                model.clearCurrentInterval();
                model.currentInterval(intervalId);
            }
            model.clearCurrentInterval = function() {
                console.debug("clearing current interval: " + model.currentInterval());
                if (model.currentInterval()) {
                    clearInterval(model.currentInterval());
                    model.currentInterval(undefined);
                }
            }
            model.tick = function() {
                model.secondsLeft(model.secondsLeft() - 1);
            }
            model.isTimerRunning = ko.computed(function() {
                return model.secondsLeft() > 0;
            });
            // activate instructions click bindings
            model.activateTemplate = function(name) {
                model.templateName(name);
            }
            model.readyParticipantsPercentage = ko.computed(function() {
                return (model.readyParticipants() / model.totalNumberOfParticipants()) * 100;
            });
            model.participantReady = function() {
                $.post('/experiment/participant-ready', { participant_group_id: model.participantGroupId() }, function(response) {
                    console.debug("successfully posted to server, notifying sockjs");
                    console.debug(response);
                    model.readyParticipants(response.number_of_ready_participants);
                    getWebSocket().send(createReadyEvent("Participant finished reading instructions"));
                    model.activateTemplate("WAITING_ROOM");
                });
            }
            model.showOtherGroup = function() {
                model.shouldShowOtherGroup(true);
            }
            model.shouldShowOtherGroup = ko.observable(false);
            model.numberOfTreesPerRow = ko.observable(10);
            model.isResourceEmpty = ko.computed(function() {
                return model.resourceLevel() == 0;
            })
            model.resourcesToDisplay = ko.computed(function() {
                if (model.resourceLevel() > 0) {
                    return Math.min(model.resourceLevel(), model.maximumResourcesToDisplay());
                }
                return 0;
            });
            model.resourceImageUrl = ko.observable("{{STATIC_URL}}images/forestry/pine-tree.png");
            model.resourceImageBackgroundUrl = ko.observable("url('{{STATIC_URL}}images/forestry/pine-tree.png')");
            model.resourceImageWidth = ko.computed(function() {
                return model.resourcesToDisplay() * 30 + "px";
            });
            model.resourceImageHeight = ko.observable("79px");
            model.startRound = function() {
                if (model.submitted() || ! model.alive()) {
                    model.disableHarvestForm();
                    model.disableChatForm();
                    return;
                }
                console.debug("starting round");
                if (isInt(model.timeRemaining()) && model.timeRemaining() > 0) {
                    model.setupChat();
                    model.secondsLeft(model.timeRemaining());
                    model.setCurrentInterval(
                        setInterval(function() {
                            model.tick();
                            if (model.secondsLeft() > 30 && ! model.isPracticeRound()) {
                                model.disableHarvestForm();
                            }
                            else {
                                model.enableHarvestForm();
                            }
                            if (! model.isTimerRunning()) {
                                model.submitDecision();
                                model.clearCurrentInterval();
                            }
                        },
                        1000));
                }
            };
            model.submitDecision = function(data, evt) {
                model.enableHarvestForm();
                var formData = $('#vcweb-form').serialize();
                model.disableHarvestForm();
                model.disableChatForm();
                console.debug(formData);
                $.post('submit-harvest-decision', formData, function(response) {
                    console.log(response);
                    model.update($.parseJSON(response.experimentModelJson));
                    // FIXME: forward the response message to the chat window should be handled completely on the server
                    // side instead of ping-ponging to the client side back to the real time server back out to all
                    // clients in this group
                    getWebSocket().send(createReadyEvent(response.message));
                    model.clearCurrentInterval();
                });
            }
            model.submitChatMessage = function(data, evt) {
                evt.preventDefault();
                console.log("clicking chat message");
                var message = $('#chatMessage').val();
                if (message) {
                    $('#chatMessage').val('');
                    getWebSocket().send(createMessageEvent(message));
                    $('#chatMessage').focus();
                }
            }
            model.update = function() {
                $.get('view-model', { participant_group_id: model.participantGroupId() }, function(data) {
                    console.debug("retrieved view model successfully");
                    console.debug(data);
                    ko.mapping.fromJS(data, model);
                    model.afterRenderTemplate();
                    $('#progress-modal').modal('hide');
                });
            }
            model.setFormDisabled = function(formId, disabled) {
                // disable all form inputs
                if (formId.indexOf("#") != 0) {
                    formId = "#" + formId;
                }
                $(formId + " :input").prop("disabled", disabled);
            }
            model.enableHarvestForm = function() {
                model.setFormDisabled("#vcweb-form", false);
            }
            model.disableHarvestForm = function() {
                model.setFormDisabled("#vcweb-form", true);
            }
            model.enableChatForm = function() {
                model.setFormDisabled("#chat-form", false);
            }
            model.disableChatForm = function() {
                model.setFormDisabled("#chat-form", true);
            }
            model.setupChat = function() {
                var chatDisabled = model.isPracticeRound() || ! model.chatEnabled();
                model.setFormDisabled("#chat-form", chatDisabled);
            }
            model.afterRenderTemplate = function(elements) {
                if (model.templateId() === "REGULAR") {
                    model.startRound()
                }
                model.setupChat();
            }
            return model;
        }
        function initialize(experimentModelJson) {
            var experimentModel = new ExperimentModel(experimentModelJson);
            ko.applyBindings(experimentModel);
            var s = connect();
            s.onmessage = function(json) {
                console.debug(json);
                var data = $.parseJSON(json.data);
                console.debug(data);
                switch (data.event_type) {
                    case 'chat':
                        experimentModel.chatMessages.unshift(data);
                        console.debug("received chat message:" + json);
                        break;
                    case 'update':
                        $('#progress-modal').modal('show');
                        experimentModel.update();
                        break;
                    case 'participant_ready':
                        $.get('/experiment/{{experiment.pk}}/check-ready-participants', function(response) {
                            experimentModel.readyParticipants(response.number_of_ready_participants);
                        });
                        break;
                    default:
                        console.debug("unhandled json message:" + json);
                        break;
                }
            };
        }
        var experimentModelJson = $.parseJSON("{{ experimentModelJson|escapejs }}");
        initialize(experimentModelJson);
        $('[data-content]').popover({placement: 'top', trigger: 'hover'});
    });
</script>
{% endblock %}
