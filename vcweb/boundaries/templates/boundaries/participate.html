{% extends "participant/base.html" %}

{% block page %}
<form class='form-horizontal'>
    <h4>Experimenter Panel</h4>
    <div class='control-group'>
        <label class='control-label' for='set-resource-level'>Resource level</label>
        <div class='controls'>
            0 <input type='range' id='set-resource-level' data-bind='value: resourceLevel' min='0' max='100' /> 100
        </div>
    </div>
    <div class='control-group'>
        <label class='control-label' for='set-survival-cost'>Survival cost</label>
        <div class='controls'>
            <input class='input-small' type='number' id='set-survival-cost' data-bind='value:survivalCost' />
        </div>
    </div>
    <div class='control-group'>
        <label class='control-label' for='set-storage'>Storage</label>
        <div class='controls'>
            <input class='input-small' type='number' id='set-storage' data-bind='value:storage' />
        </div>
    </div>
    <div class='control-group'>
        <label class='control-label' for='set-regrowth-rate'>Regrowth rate</label>
        <div class='controls'>
            <input class='input-small' type='number' id='set-regrowth-rate' data-bind='value:regrowthRate' />
        </div>
    </div>
    <div class='control-group'>
        <label class='control-label' for='pick-template'>Round template to display</label>
        <div class='controls'>
            <select id='pick-template'>
                <option value='WELCOME'>Welcome</option>
                <option value='INSTRUCTIONS'>Instructions</option>
                <option value='PRACTICE'>Practice round</option>
                <option value='REGULAR'>Actual round</option>
                <option value='CHAT'>Chat</option>
                <option value='WAIT'>Waiting room</option>
            </select>
        </div>
    </div>
</fieldset>
</form>
<h4>Template Preview</h4>
<table class='table table-bordered table-condensed'>
    <caption>Status</caption>
    <thead>
        <tr><th>Resources left</th><th>Storage</th><th>Survival cost</th><th>Regrowth rate</th></tr>
    </thead>
    <tbody>
    <tr class='success'>
        <td data-bind='text: resourceLevel'></td>
        <td data-bind='text: storage'></td>
        <td data-bind='text: survivalCost'></td>
        <td data-bind='text: regrowthRate'></td>
    </tr>
    </tbody>
</table>
<div data-bind='template: { name: roundType() }'>
</div>
{% endblock page %}
{% block javascript %}
{{ block.super }}
<!-- ko templates -->
<script type='text/html' id='CHAT'>
{% include "forms/chat-template.html" %}
</script>
<script type='text/html' id='WELCOME'>
<h3>Welcome</h3>
<p class='lead'>
    Welcome.  This experiment will begin shortly after everyone has been assigned a station.  Please <strong>wait quietly and do
    not close this window, open any other applications, or communicate with any of the other participants</strong>.  Thank you
    for your cooperation. Please also make sure to turn off any mobile devices before the experiment begins.
</p>
</script>
<script type='text/html' id='INSTRUCTIONS'>
<h3>Instructions</h3>
<p>
You have been randomly assigned to a group of size <strong data-bind='text:participantsPerGroup'></strong>.
In this experiment you will be sharing a resource (forest?) with the other members of your group.  The experiment consists of 
<span class='badge badge-important' data-bind='text:numberOfRounds'></span> rounds.  In each round you will make a
decision of how many resources to harvest.  The resources can regenerate over time as long as there some left, at a rate
of (do we describe the regrowth rate here?).  The resources you collect will be put into your <b>storage</b>
</p>
<h4>Survival</h4>
Each round you must have <b>at least</b> <span class='badge badge-important' data-bind='text: survivalCost'></span> resources in your storage to survive.
</p>
<p>
To better illustrate, we will begin with two practice rounds.  These rounds will not contribute to your earnings.
</p>
</script>
<script type='text/html' id='WAIT'>
<h1>Not implemented yet, not sure if we need this template.</h1>
<p>
Do we need a waiting page after participants enter their decision or just return to the same form that shows the harvest
decision?
</p>
</script>
<script type='text/html' id='REGULAR'>
<h3 data-bind='text: roundSequenceLabel'></h3>
<div data-bind='if: practiceRound'>
<div class='alert alert-error alert-block'>
<h4>NOTE</h4>
This is a practice round.  The decisions you make in this round will <b>NOT</b> contribute to your earnings.
</div>
</div>

<div data-bind="if: maxHarvestDecision() > 0">
    <div style="background: url('{{STATIC_URL}}images/forestry/pine-tree.png'); width:{{max_width}}px; height: {{max_height}}px;">
        &nbsp;
    </div>
</div>
<div data-bind="ifnot: maxHarvestDecision() > 0">
    <div style='padding: 8px; margin: auto; border: solid 1px; background: #E8E8E8 url({{STATIC_URL}}images/forestry/deforestation.jpg) no-repeat center; height: 282px; width:425px;'>
        &nbsp;
    </div>
</div>
<div class='alert alert-message'>
    You require <span class='badge badge-important' data-bind='text:survivalCost'></span> to survive and you currently have <span class='badge badge-success' data-bind='text: storage'></span> resources stored.  
    There are <span class='badge badge-warning' data-bind='text: resourceLevel'></span> resources left for your entire group.
</div>

<div data-bind='if: hasSubmit'>
<div class='alert alert-error'>
    You have already made a decision to harvest <b>{{ harvest_decision.value }}</b> resources.  You may change your
    decision until the experimenter ends the round.
</div>
</div>

<div data-bind='if: maxHarvestDecision() > 0'>
<form id='vcweb-form' action='' method='post' class='form-horizontal'>
    {% csrf_token %}
    <div class='control-group'>
        How many resources will you harvest this round? <br/>
        <label class='control-label' for='harvestDecision'>
            Enter a number between 0 and <span class='badge badge-info' data-bind='text:maxHarvestDecision'></span>:
        </label>
        <div class='controls'>
            <input id='harvestDecision' type="text" name='harvest_decision' class='required digits' maxlength='1' placeholder="0" />
            <input id='participantGroupId' type='hidden' name='participant_group_id' />
        </div>
    </div>
    <div class='control-group'>
        <div class='controls'>
            <button id='submitDecision' type='submit' class='btn'>Harvest</button>
        </div>
    </div>
</form>
</div>
<div data-bind='if: maxHarvestDecision == 0'>
<div class='alert alert-error'>
    There are no longer enough trees to harvest. Please wait until the next round begins.
</div>
</div>
</script>
<script type="text/javascript">
    var experimentModelJson = $.parseJSON("{{ experimentModelJson|escapejs }}");
    $(function() {
        function ExperimentModel(experimentModelJson) {
            var self = this;
            var model = ko.mapping.fromJS(experimentModelJson);
            return model;
        }
        function update(experimentModel) {
            return function(data) {
                ko.mapping.fromJS(data, experimentModel);
            }
        }
        function initialize(experimentModelJson) {
            var experimentModel = new ExperimentModel(experimentModelJson);
            ko.applyBindings(experimentModel);
            // FIXME: needs to be updated for KO
            /*
            $("#vcweb-form").validate({
                rules: {
                    harvest_decision: {
                        required: true,
                        range: [0, {{max_harvest_decision}}]
                    }
                },
                messages: {
                    harvest_decision: {
                        required: "Please enter a harvest decision",
                        range: "Please enter a number between 0 and {{ max_harvest_decision }}"
                    }
                },
            });
            $('#harvest-decision-id').focus(function() {
                this.select();
            });
            $('#harvest-decision-id').focus();
            */
            var s = connect();
            s.onmessage = function(json_string) {
                var json = jQuery.parseJSON(json_string);
                console.debug(json);
                update(json);
            };
            $('#pick-template').change(function() {
                var templateName = $(this).val();
                console.debug("switching to template: " + templateName);
                if (templateName === "PRACTICE") {
                    templateName = "REGULAR";
                    experimentModel.practiceRound(true);
                }
                else if (templateName === "REGULAR") {
                    experimentModel.practiceRound(false);
                }
                else {
                    experimentModel.roundType(templateName);
                    return false;
                }
                experimentModel.roundType(templateName);
                $('#submitDecision').click(function(evt) {
                    evt.preventDefault();
                    // make ajax post with data, update experiment model
                    $.post("participate", $('#vcweb-form').serialize()).success(function(data) {
                        console.log("setting hasSubmit to true.");
                        alert("submit vcweb form back to participate");
                        experimentModel.hasSubmit(true);
                    });
                    return false;
                });
            });
        }
        initialize(experimentModelJson);
        //send the message when submit is clicked
        $('#chatform').submit(function (evt) {
            var line = $('#chatText').val()
            if (line) {
                $('#chatText').val('')
                s.send(createMessageEvent(line));
            }
            return false;
        });
    });
</script>
{% endblock %}
