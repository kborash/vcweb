{% extends "participant/base.html" %}

{% block page %}
<form class='form-horizontal'>
    <h4>Experimenter Panel</h4>
    <div class='control-group'>
        <label class='control-label' for='set-resource-level'>Resource level</label>
        <div class='controls'>
            0 <input type='range' id='set-resource-level' data-bind='value: resourceLevel' min='0' max='100' /> 100
        </div>
    </div>
    <div class='control-group'>
        <label class='control-label' for='set-survival-cost'>Survival cost</label>
        <div class='controls'>
            <input class='input-small' type='number' id='set-survival-cost' data-bind='value:survivalCost' />
        </div>
    </div>
    <div class='control-group'>
        <label class='control-label' for='set-storage'>Storage</label>
        <div class='controls'>
            <input class='input-small' type='number' id='set-storage' data-bind='value:storage' />
        </div>
    </div>
    <div class='control-group'>
        <label class='control-label' for='set-regrowth-rate'>Regrowth rate</label>
        <div class='controls'>
            <input class='input-small' step='0.1' type='number' id='set-regrowth-rate' data-bind='value:regrowthRate' />
        </div>
    </div>
    <div class='control-group'>
        <label class='control-label' for='pick-template'>Round template to display</label>
        <div class='controls'>
            <select id='pick-template'>
                <option value='WELCOME'>Welcome</option>
                <option value='INSTRUCTIONS' selected>Instructions</option>
                <option value='PRACTICE'>Practice round</option>
                <option value='REGULAR'>Actual round</option>
                <option value='CHAT'>Chat</option>
            </select>
        </div>
    </div>
</fieldset>
</form>
<h4>Template Preview</h4>
<table class='table table-bordered table-condensed'>
    <caption>Group Status</caption>
    <thead>
        <tr><th>Group</th><th>Resources left</th><th>Storage</th><th>Survival cost</th><th>Regrowth rate</th></tr>
    </thead>
    <tbody data-bind='foreach: groupData'>
    <tr class='success'>
        <td data-bind='text: groupId'></td>
        <td data-bind='text: resourceLevel'></td>
        <td data-bind='text: allStorage'></td>
        <td data-bind='text: survivalCost'></td>
        <td data-bind='text: regrowthRate'></td>
    </tr>
    </tbody>
</table>
<div data-bind='template: { name: roundType() }'>
</div>
{% endblock page %}
{% block javascript %}
{{ block.super }}
<!-- ko templates -->
<script type='text/html' id='CHAT'>
{% include "forms/chat-template.html" %}
</script>
<script type='text/html' id='WELCOME'>
<h3>Welcome</h3>
<p class='lead'>
    Welcome.  This experiment will begin shortly after everyone has been assigned a station.  Please <strong>wait quietly and do
    not close this window, open any other applications, or communicate with any of the other participants</strong>.  Thank you
    for your cooperation. Please also make sure to turn off any mobile devices before the experiment begins.
</p>
</script>
<script type='text/html' id='INSTRUCTIONS'>
<h3>Instructions</h3>
<p>
You have been randomly assigned to a group of size <strong data-bind='text:participantsPerGroup'></strong>.
In this experiment you will be sharing a resource (forest?) with the other members of your group.  The experiment consists of 
<span class='badge badge-important' data-bind='text:numberOfRounds'></span> rounds.  In each round you will make a
decision of how many resources to harvest.  The resources can regenerate over time as long as there some left, at a rate
of (do we describe the regrowth rate here?).  The resources you collect will be put into your <b>storage</b>
</p>
<h4>Survival</h4>
Each round you must have <b>at least</b> <span class='badge badge-important' data-bind='text: survivalCost'></span> resources in your storage to survive.
</p>
<p>
To better illustrate, we will begin with two practice rounds.  These rounds will not contribute to your earnings.
</p>
</script>
<script type='text/html' id='REGULAR'>
<h3 data-bind='text: roundSequenceLabel'></h3>
<div data-bind='if: practiceRound'>
<div class='alert alert-error alert-block'>
<h4>NOTE</h4>
This is a practice round.  The decisions you make in this round will <b>NOT</b> contribute to your earnings.
</div>
</div>

<div data-bind="ifnot: isResourceEmpty()" id='resourceDisplay'>
    <div data-bind='style: { width: resourceImageWidth(), height: resourceImageHeight(), background: resourceImageUrl() }'>
        &nbsp;
    </div>
    <div class='alert alert-info'><h4>Note</h4>Displaying <strong data-bind='text:resourcesToDisplay()'></strong> resource(s) of <strong data-bind='text:resourceLevel'></strong></div>
</div>
<div data-bind="if: isResourceEmpty()">
    <div style='padding: 8px; margin: auto; border: solid 1px; background: url("{{STATIC_URL}}images/forestry/deforestation.jpg") no-repeat center; height: 282px; width:425px;'>
        &nbsp;
    </div>
    <div class='alert alert-error'>There are no more resources to harvest. Please wait until the next round begins.</div>
</div>
<div class='alert alert-message'>
    You require <span class='badge badge-important' data-bind='text:survivalCost'></span> to survive and you currently have <strong data-bind='text: storage'></strong> resources stored.  
    There are <span class='badge badge-warning' data-bind='text: resourceLevel'></span> resources left for your entire
    group, and you can harvest up to <strong data-bind='text:maxHarvestDecision'></strong> resources.
</div>

<div data-bind='if: hasSubmit'>
<div class='alert alert-error'>
    You have submitted a decision to harvest <span class='badge badge-important' data-bind='text: harvestDecision'></span> resources.  You may change your
    decision until the experimenter ends the round. (TIM: is this ok?)
</div>
</div>

<div data-bind='ifnot: isResourceEmpty()'>
<form id='vcweb-form' action='' method='post' class='form-horizontal'>
    {% csrf_token %}
    <div class='control-group'>
        <label class='control-label' for='harvestDecision'>
        Harvest Decision
        </label>
        <div class='controls'>
            <input id='harvestDecision' placeholder='0' type="number" name='harvest_decision' class='required' min="0" data-bind="value: harvestDecision, attr: { max: maxHarvestDecision }" /> 
            <input id='participantGroupId' type='hidden' name='participant_group_id' />
        </div>
    </div>
    <div class='control-group'>
        <div class='controls'>
            <button id='submitDecision' type='submit' class='btn'>Harvest</button>
        </div>
    </div>
</form>
</div>
</script>
<script type="text/javascript">
    $(function() {
        function ExperimentModel(experimentModelJson) {
            var self = this;
            var model = ko.mapping.fromJS(experimentModelJson);
            model.harvestDecision = ko.observable(0);
            model.numberOfTreesPerRow = 10;
            model.isResourceEmpty = function() {
                return model.resourceLevel() == 0;
            }
            model.resourcesToDisplay = function() {
                if (model.resourceLevel() > 0) {
                    return Math.min(model.resourceLevel(), 20);
                }
                return 0;
            }
            model.resourceImageUrl = function() {
                return "url('{{STATIC_URL}}images/forestry/pine-tree.png')";
            }
            model.resourceImageWidth = function() { 
                return model.resourcesToDisplay() * 30 + "px"; 
            }
            model.resourceImageHeight = function() {
                return "79px;"
            }
            return model;
        }
        function update(experimentModel) {
            return function(data) {
                ko.mapping.fromJS(data, experimentModel);
            }
        }
        function initialize(experimentModelJson) {
            var experimentModel = new ExperimentModel(experimentModelJson);
            ko.applyBindings(experimentModel);
            var s = connect();
            s.onmessage = function(json_string) {
                var json = jQuery.parseJSON(json_string);
                console.debug(json);
                update(json);
            };
            $('#pick-template').change(function() {
                var templateName = $(this).val();
                console.debug("switching to template: " + templateName);
                if (templateName === "PRACTICE") {
                    templateName = "REGULAR";
                    experimentModel.practiceRound(true);
                }
                else if (templateName === "REGULAR") {
                    experimentModel.practiceRound(false);
                }
                else {
                    experimentModel.roundType(templateName);
                    return false;
                }
                experimentModel.roundType(templateName);
                $('#submitDecision').click(function(evt) {
                    console.log("CLICKED");
                    evt.preventDefault();
                    // make ajax post with data, update experiment model
                    /*
                    $.post("participate", $('#vcweb-form').serialize(), function(data) {
                        console.log("successfully posted form.");
                    });
                    */
                    experimentModel.hasSubmit(true);
                    console.log("set hassubmit to true");
                    return false;
                });
            });
        }
        //send the message when submit is clicked
        $('#chatform').submit(function (evt) {
            var line = $('#chatText').val()
            if (line) {
                $('#chatText').val('')
                s.send(createMessageEvent(line));
            }
            return false;
        });
        var experimentModelJson = $.parseJSON("{{ experimentModelJson|escapejs }}");
        initialize(experimentModelJson);
    });
</script>
{% endblock %}
